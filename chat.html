<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firestore Chat</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 40px auto; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; }
    .chat-message { margin-bottom: 10px; }
    #msg-input { width: 80%; padding: 6px; }
    #msg-form { margin-top: 10px; }
  </style>
</head>
<body>

  <h2>üî• Firestore Chat</h2>
  <div id="chat-box"></div>

  <form id="msg-form">
    <input id="msg-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <div style="margin-top: 10px;">
    üí∞ –ë–∞–ª–∞–Ω—Å: <span id="balance-display">0.0</span> $POST
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      orderBy,
      query
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuL4tpaSsw1ylXf2VZrQ1b_2t_Kxd97cI",
      authDomain: "post-ad037.firebaseapp.com",
      projectId: "post-ad037",
      storageBucket: "post-ad037.firebasestorage.app",
      messagingSenderId: "377312187432",
      appId: "1:377312187432:web:565f47c145e0e73ac0911d",
      measurementId: "G-T48NR3B9VW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: —Å–Ω–∞—á–∞–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç, –ø–æ—Ç–æ–º –∫–æ–ª–ª–µ–∫—Ü–∏—è
    const globalDocRef = doc(db, 'chats', 'global');
    const messagesRef = collection(globalDocRef, 'messages');
    const q = query(messagesRef, orderBy('timestamp'));

    let currentUser = null;
    let userBalance = 0.0;

    // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
    signInAnonymously(auth).then(() => {
      console.log('‚úÖ Anonymous sign-in');
    }).catch(console.error);

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        console.log('üë§ Authenticated as', user.uid);
      } else {
        currentUser = null;
      }
    });

    // –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function displayMessage({ text, uid, name, imageUrl }) {
      const chatBox = document.getElementById('chat-box');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = `<strong>${escapeHtml(name || 'User')}:</strong> ${escapeHtml(text || '')}`;
      if (imageUrl) {
        div.innerHTML += `<br><img src="${escapeHtml(imageUrl)}" style="max-width:150px;">`;
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    onSnapshot(q, snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          displayMessage(msg);
        }
      });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    const msgForm = document.getElementById('msg-form');
    const msgInput = document.getElementById('msg-input');

    msgForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text || !currentUser) return;

      try {
        await addDoc(messagesRef, {
          uid: currentUser.uid,
          name: 'Anon',
          text,
          timestamp: serverTimestamp()
        });

        userBalance += 0.1;
        document.getElementById('balance-display').textContent = userBalance.toFixed(1);
        msgInput.value = '';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
      }
    });
  </script>

</body>
</html>
