<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MESH</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/logo2.png">
  <style>
    /* --- FRIEND.TECH STYLE ENHANCEMENTS --- */
    body,
    html {
      background: #fafbfc;
      font-family: 'Inter', 'Roboto', Arial, sans-serif;
      color: #222;
    }

    .sidebar {
      background: #fff;
      border-right: 1px solid #eee;
      min-height: 100vh;
      width: 85vw;
      max-width: 300px;
      padding: 16px 0;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
      position: fixed;
      left: 0;
      top: 0;
      z-index: 1000;
      transition: left 0.3s ease;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-item {
      padding: 12px 16px;
      margin: 4px 8px;
      border-radius: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-item i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .mobile-menu-btn {
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      padding: 8px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .mobile-menu-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .mobile-menu-btn span {
      display: block;
      width: 24px;
      height: 2px;
      background: white;
      margin: 4px 0;
      transition: 0.3s;
    }

    .mobile-menu-btn.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .mobile-menu-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    @media (max-width: 900px) {
      .mobile-menu-btn {
        display: flex;
      }

      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }

      .content {
        margin-top: 60px;
        padding: 0 10px;
      }

      .sidebar {
        width: 100%;
        max-width: none;
      }
    }

    .main-content,
    .wallet-section,
    .tab-content,
    .discover-list {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      padding: 40px 48px;
      margin: 32px 0;
    }

    .wallet-header,
    .chat-header,
    .discover-tabs {
      margin-bottom: 32px;
    }

    .wallet-btn,
    .register-btn,
    .create-club-btn,
    .chat-tab,
    .discover-tab,
    .chat-notify-btn,
    .wallet-profile-btn,
    .wallet-profile-withdraw,
    .wallet-fund-btn,
    .wallet-logout-btn,
    .save-profile-btn,
    .button,
    .btn,
    button {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 28px !important;
      font-weight: bold;
      font-size: 1.08rem;
      box-shadow: 0 2px 8px rgba(160, 32, 240, 0.08);
      transition: background 0.2s;
    }

    .wallet-btn:hover,
    .register-btn:hover,
    .create-club-btn:hover,
    .chat-tab:hover,
    .discover-tab:hover,
    .chat-notify-btn:hover,
    .wallet-profile-btn:hover,
    .wallet-profile-withdraw:hover,
    .wallet-fund-btn:hover,
    .wallet-logout-btn:hover,
    .save-profile-btn:hover,
    .button:hover,
    .btn:hover,
    button:hover {
      background: #9900ff;
    }

    input,
    select,
    textarea {
      border: 1px solid #eee !important;
      border-radius: 10px !important;
      padding: 12px 16px !important;
      background: #fafbfc !important;
      font-size: 1.08rem !important;
      margin-bottom: 16px !important;
    }

    .card,
    .panel,
    .block {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      padding: 16px;
      margin-bottom: 16px;
      width: 100%;
      box-sizing: border-box;
    }

    ::-webkit-scrollbar {
      width: 8px;
      background: #f0f0f0;
    }

    ::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 8px;
    }

    @media (max-width: 900px) {

      .main-content,
      .wallet-section,
      .tab-content,
      .discover-list {
        padding: 24px 8px;
      }

      .card,
      .panel,
      .block {
        padding: 18px 8px;
      }

      .sidebar {
        width: 60px;
        padding-top: 12px;
      }
    }

    @media (max-width: 600px) {

      .main-content,
      .wallet-section,
      .tab-content,
      .discover-list {
        padding: 8px 2vw;
        margin: 12px 0;
      }

      .card,
      .panel,
      .block {
        padding: 8px 2vw;
        margin-bottom: 12px;
      }
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: white;
      min-width: 0;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .container {
      min-height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .content {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 25vh;
      max-width: 1200px;
      width: 100%;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .logo {
      width: 100px;
      margin-bottom: 48px;
    }

    h1 {
      font-size: 2.5rem;
      margin: 0 0 24px 0;
      font-weight: 700;
      text-align: center;
    }

    .purple {
      color: #a020f0;
    }

    .blue {
      color: #a020f0;
    }

    .black {
      color: #222;
    }

    .subtitle {
      color: #888;
      margin: 0 0 48px 0;
      font-size: 1.2rem;
      text-align: center;
      max-width: 600px;
      line-height: 1.6;
    }

    .login-btn {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 16px 80px;
      font-size: 1.2rem;
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 0;
      transition: background 0.2s;
    }

    .login-btn:hover {
      background: #9900ff;
    }

    .footer {
      position: fixed;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 60px;
      padding: 0 20px;
    }

    .footer-link {
      color: #a020f0;
      text-decoration: none;
      font-size: 1rem;
      transition: text-decoration 0.2s;
    }

    .footer-link:hover {
      text-decoration: underline;
    }

    /* --- Modal styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px auto;
      max-height: calc(100vh - 40px);
    }

    @media (max-width: 600px) {
      .modal {
        padding: 16px;
        align-items: flex-end;
      }
      
      .modal-content {
        max-width: 90%;
        padding: 24px 16px;
        margin: 0 auto;
        border-radius: 12px 12px 0 0;
      }
    }

    @media (max-width: 400px) {
      .modal {
        padding: 12px;
      }
      
      .modal-content {
        max-width: 100%;
        padding: 20px 12px;
        border-radius: 12px 12px 0 0;
      }
    }

    .close {
      position: absolute;
      right: 16px;
      top: 12px;
      font-size: 2rem;
      cursor: pointer;
      color: #888;
    }

    .twitter-btn {
      background: #1da1f2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 32px;
      font-size: 1rem;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .divider {
      margin: 12px 0;
      color: #aaa;
      font-size: 0.9rem;
    }

    #registerForm {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 400px;
    }

    #registerForm input {
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      width: 100%;
    }

    .register-btn {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 1rem;
      cursor: pointer;
    }

    /* --- Wallet styles --- */
    .wallet-section {
      padding: 40px 20px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .wallet-header {
      display: flex;
      gap: 60px;
      margin-bottom: 40px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .wallet-header-coins {
      text-align: center;
      /* Центрируем текст внутри элементов */
    }

    .wallet-header>div {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Центрируем содержимое каждого div */
    }

    .wallet-label {
      color: #888;
      font-size: 1rem;
    }

    .wallet-value,
    .wallet-post-price {
      font-size: 2rem;
      font-weight: bold;
      color: #222;
    }

    .wallet-post-price {
      color: #a020f0;
    }

    .wallet-grid-3x2 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 48px 80px;
      justify-items: center;
      align-items: start;
      max-width: 900px;
      margin: 0 auto;
    }

    .wallet-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 160px;
      background: none;
    }

    .wallet-icon {
      margin-bottom: 8px;
      display: block;
    }

    .wallet-item-label {
      color: #888;
      font-size: 1rem;
      margin-bottom: 2px;
      background: #f5f5f5;
      border-radius: 6px;
      padding: 2px 10px;
      margin-top: 2px;
    }

    .wallet-item-value {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 8px;
      margin-top: 2px;
      color: #a020f0;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .wallet-btn {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      margin-top: 4px;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(160, 32, 240, 0.08);
      transition: background 0.2s;
    }

    .wallet-btn:hover {
      background: #9900ff;
    }

    @media (max-width: 1200px) {
      .wallet-grid-3x2 {
        max-width: 98vw;
      }
    }

    @media (max-width: 900px) {
      .wallet-grid-3x2 {
        gap: 32px 24px;
        max-width: 100vw;
      }

      .main-content {
        padding-left: 0;
        padding-right: 0;
      }
    }

    @media (max-width: 700px) {
      .wallet-grid-3x2 {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: repeat(3, auto);
      }

      .wallet-item {
        min-width: 0;
      }

      .wallet-icon,
      .discover-avatar,
      .club-chat-avatar {
        width: 40px !important;
        height: 40px !important;
      }

      .sidebar {
        width: 60px;
        padding-top: 12px;
      }

      .sidebar-logo {
        margin-bottom: 16px;
      }

      .sidebar-item {
        padding: 12px 0 12px 10px;
        font-size: 1rem;
      }

      .main-app {
        flex-direction: column;
      }

      .main-content {
        padding: 16px 0 0 0;
      }

      .club-chat-modal-content,
      .create-club-modal-content {
        max-width: 98vw;
        min-width: 0;
        padding: 0 2vw;
      }
    }

    @media (max-width: 500px) {
      .wallet-grid-3x2 {
        grid-template-columns: 1fr;
        grid-template-rows: none;
        gap: 24px 0;
      }

      .wallet-item {
        min-width: 0;
      }

      .wallet-icon,
      .discover-avatar,
      .club-chat-avatar {
        width: 32px !important;
        height: 32px !important;
      }

      .sidebar {
        width: 100%;
        max-width: none;
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-app {
        flex-direction: column;
      }

      .main-content {
        padding: 8px 0 0 0;
        width: 100%;
      }

      .modal-content,
      .club-chat-modal-content,
      .create-club-modal-content {
        max-width: 100vw;
        min-width: 0;
        border-radius: 0;
        padding: 0 2vw;
      }

      .chat-header,
      .chat-tabs,
      .chat-notify,
      .chat-list,
      .wallet-header,
      .wallet-grid,
      .discover-tabs,
      .discover-list {
        padding-left: 2vw !important;
        padding-right: 2vw !important;
      }

      .club-chat-header,
      .club-chat-form {
        padding-left: 2vw !important;
        padding-right: 2vw !important;
      }

      .club-chat-messages {
        padding-left: 2vw !important;
        padding-right: 2vw !important;
      }

      .create-club-photo-label {
        width: 80px;
        height: 80px;
      }

      .register-btn,
      .wallet-btn,
      .create-club-btn,
      .chat-tab,
      .discover-tab,
      .chat-notify-btn {
        font-size: 1rem;
        padding: 10px 0;
      }

      .modal {
        align-items: flex-end;
      }
    }

    /* --- Main app layout styles --- */
    .main-app {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 180px;
      background: #fafbfc;
      border-right: 1px solid #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 32px;
    }

    .sidebar-logo {
      margin-bottom: 40px;
    }

    .sidebar-menu {
      width: 100%;
    }

    .sidebar-item {
      padding: 16px 0 16px 32px;
      font-size: 1.1rem;
      color: #888;
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }

    .sidebar-item.active {
      color: #a020f0;
      background: #eaf7fd;
      border-left: 4px solid #a020f0;
      font-weight: 600;
    }

    .main-content {
      flex: 1;
      padding: 40px 0 0 0;
      margin-left: 180px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 180px);
    }

    /* --- Chat tab styles --- */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .chat-search {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #eee;
      border-radius: 8px;
      font-size: 1rem;
    }

    .chat-bell {
      font-size: 1.5rem;
      color: #bbb;
      margin-left: auto;
    }

    .chat-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .chat-tab {
      background: #f5f5f5;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1rem;
      color: #222;
      cursor: pointer;
      font-weight: 500;
    }

    .chat-tab.active {
      background: #a020f0;
      color: #fff;
    }

    .chat-notify {
      background: #a020f0;
      color: #fff;
      border-radius: 8px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .chat-notify-btn {
      background: #fff;
      color: #222;
      border: none;
      border-radius: 6px;
      padding: 4px 16px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 500;
    }

    .chat-list {
      margin-top: 12px;
    }

    .chat-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 600;
      color: #222;
    }

    .chat-msg {
      color: #aaa;
      font-size: 0.95rem;
    }

    .chat-price {
      color: #bbb;
      font-size: 0.95rem;
    }

    /* --- Discover styles --- */
    .discover-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0 20px;
    }

    .discover-tab {
      background: #f5f5f5;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 1.1rem;
      color: #222;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .discover-tab:hover {
      background: #efefef;
    }

    .discover-tab.active {
      background: #a020f0;
      color: #fff;
    }

    .discover-list {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      padding: 20px;
    }

    .discover-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .discover-item:hover {
      background: #fafafa;
    }

    .discover-item:last-child {
      border-bottom: none;
    }

    .discover-rank {
      font-size: 1.2rem;
      font-weight: 600;
      color: #a020f0;
      min-width: 30px;
    }

    .discover-avatar {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .discover-info {
      flex: 1;
      min-width: 0;
      padding-right: 16px;
    }

    .discover-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #222;
    }

    .discover-desc {
      color: #666;
      font-size: 0.95rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .discover-price {
      color: #a020f0;
      font-size: 1.05rem;
      font-weight: 600;
      margin-left: 8px;
      white-space: nowrap;
      padding: 8px 16px;
      background: rgba(160, 32, 240, 0.08);
      border-radius: 8px;
    }

    /* --- Create club modal styles --- */
    .create-club-modal-content {
      max-width: 600px;
      width: 100%;
      padding: 32px;
      border-radius: 18px;
      position: relative;
      transition: all 0.3s ease;
      background: #fff;
      margin: 5% auto;
    }

    @media (max-width: 900px) {
      .create-club-modal-content {
        max-width: 90vw;
        padding: 24px;
        margin: 10% auto;
      }
      
     
      
      .create-club-photo-label {
        width: 100px;
        height: 100px;
        margin: 0 auto 16px;
      }
      
      .create-club-row {
        flex-direction: column;
        gap: 16px;
      }
      
      .create-club-input[type="text"],
      .create-club-input[type="number"] {
        width: 100%;
        min-width: 0;
      }
      
      .create-club-curves {
        gap: 12px;
      }
      
      .curve-option {
        min-width: 0;
        flex: 1;
        padding: 12px;
      }
    }

    @media (max-width: 600px) {
      .create-club-modal-content {
        max-width: 95vw;
        padding: 20px;
        margin: 15% auto;
        border-radius: 16px;
      }
      
     
      
      .create-club-photo-label {
        width: 120px;
        height: 120px;
      }
      
      .create-club-input {
        font-size: 1.1rem !important;
        padding: 14px 16px !important;
      }
      
      .create-club-section-label {
        font-size: 1.1rem;
        margin-top: 8px;
      }
      
      .create-club-curves {
        flex-direction: column;
        gap: 16px;
      }
      
      .curve-option {
        width: 100%;
        padding: 16px;
      }
      
      .create-club-btn {
        font-size: 1.2rem;
        padding: 16px 0;
        width: 100%;
      }
      
      .create-club-row[style*="margin-top:8px"] {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .create-club-row[style*="margin-top:8px"]>div {
        margin-left: 0 !important;
      }
    }

    @media (max-width: 400px) {
      .create-club-modal-content {
        max-width: 100vw;
        padding: 16px;
        margin: 20% auto;
        border-radius: 12px;
      }
      
    
      .create-club-photo-label {
        width: 140px;
        height: 140px;
      }
      
      .create-club-input {
        font-size: 1.2rem !important;
        padding: 16px 18px !important;
      }
      
      .create-club-section-label {
        font-size: 1.2rem;
      }
      
      .curve-option {
        padding: 18px;
      }
      
      .create-club-btn {
        font-size: 1.3rem;
        padding: 18px 0;
      }
    }

    .create-club-form {
      display: flex;
      flex-direction: column;

      width: 100%;
    }

    .create-club-photo-label {
      display: block;
      width: 120px;
      height: 120px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .create-club-photo-preview {
      width: 100%;
      height: 100%;
      background: #f5f5f5;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 1.1rem;
      text-align: center;
      border: 1.5px dashed #e0e0e0;
      cursor: pointer;
    }

    .create-club-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 0;
      flex-wrap: wrap;
    }

    .create-club-input {
      font-size: 1.1rem;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 0;
      background: #fff;

    }

    .create-club-input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .create-club-input[type="number"] {
      width: 80px;
    }

    .create-club-section-label {
      color: #888;
      font-size: 1rem;
      margin-bottom: 6px;
      margin-top: 8px;
    }

    .create-club-curves {
      display: flex;
      gap: 18px;
      margin-bottom: 0;
      flex-wrap: wrap;
    }

    .curve-option {
      border: 2px solid #eee;
      border-radius: 10px;
      padding: 8px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: border 0.2s;
      flex: 1;
      min-width: 120px;
    }

    .curve-option.selected {
      border: 2px solid #a020f0;
      background: #eaf7fd;
    }

    .curve-option svg {
      margin-bottom: 4px;
    }

    .create-club-btn {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 16px 0;
      font-size: 1.15rem;
      font-weight: 600;
      margin-top: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .create-club-btn:hover {
      background: #9900ff;
    }

    /* --- Club chat modal styles --- */
    .club-chat-modal-content {
      max-width: 800px;
      width: 100%;
      min-height: 500px;
      padding: 0;
      border-radius: 18px;
      position: relative;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .club-chat-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 28px 10px 28px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .club-chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }

    .club-chat-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: #222;
    }

    .club-chat-messages {
      flex: 1;
      padding: 18px 28px 12px 28px;
      overflow-y: auto;
      background: #fff;
      min-height: 200px;
      max-height: 400px;
    }

    .club-chat-message {
      margin-bottom: 12px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .club-chat-message.me {
      flex-direction: row-reverse;
    }

    .club-chat-bubble {
      background: #eaf7fd;
      color: #222;
      border-radius: 16px;
      padding: 8px 16px;
      max-width: 60%;
      font-size: 1.05rem;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .club-chat-message.me .club-chat-bubble {
      background: #a020f0;
      color: #fff;
    }

    .club-chat-form {
      display: flex;
      align-items: center;
      border-top: 1px solid #f0f0f0;
      padding: 12px 28px;
      background: #fafbfc;
    }

    #clubChatInput {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1.05rem;
      margin-right: 10px;
    }

    .club-chat-send-btn {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1.2rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .club-chat-send-btn:hover {
      background: #9900ff;
    }

    /* --- Fullscreen Web3 Chat Styles --- */
    .chat-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 4999;
    }

    .fullscreen-chat {
      display: none;
      position: fixed;
      z-index: 5000;
      background: #fff;
      flex-direction: column;
      overflow-x: hidden;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    }

    .fullscreen-chat .fschat-header {
      padding: 16px 20px;
    }

    .fullscreen-chat .fschat-messages {
      padding: 0 20px;
    }

    .fullscreen-chat .fschat-input {
      padding: 16px 20px;
      border-top: 1px solid #f0f0f0;
    }

    @media (min-width: 769px) {
      .fullscreen-chat {
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 800px;
        height: 80vh;
      }
    }

    @media (max-width: 768px) {
      .fullscreen-chat {
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
        border-radius: 0;
      }
      
      .fschat-header {
        padding: 0 12px;
        height: 56px;
      }

      .fschat-form {
        padding: 8px 12px;
        gap: 4px;
      }

      #fullscreenChatInput {
        padding: 8px 12px;
        font-size: 1rem;
      }

      .fschat-balance {
        padding: 6px 10px;
        font-size: 0.9rem;
        max-width: 100px;
      }

      .fschat-menu {
        min-width: 140px;
      }

      .fschat-menu-item {
        padding: 10px 14px;
        font-size: 0.95rem;
      }
      
      .fschat-messages {
        padding: 12px 8px;
      }
      
      .fschat-message {
        padding: 6px 12px;
        margin-bottom: 6px;
      }
      
      .fschat-message-content {
        max-width: 85%;
        padding: 6px 10px;
      }
      
      .fschat-header-left {
        gap: 8px;
      }
      
      #fullscreenChatTitle {
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      .fschat-header {
        padding: 0 8px;
        height: 52px;
      }

      .fschat-form {
        padding: 6px 8px;
        gap: 2px;
      }

      #fullscreenChatInput {
        padding: 6px 10px;
        font-size: 0.95rem;
      }

      .fschat-balance {
        padding: 4px 8px;
        font-size: 0.85rem;
        max-width: 80px;
      }

      #fullscreenChatAvatar {
        width: 32px;
        height: 32px;
      }

      #closeFullscreenChat {
        width: 28px;
        height: 28px;
        font-size: 1.3rem;
      }
      
      .fschat-messages {
        padding: 8px 4px;
      }
      
      .fschat-message {
        padding: 4px 8px;
        margin-bottom: 4px;
      }
      
      .fschat-message-content {
        max-width: 90%;
        padding: 4px 8px;
        font-size: 0.9rem;
      }
      
      #fullscreenChatTitle {
        font-size: 0.9rem;
      }
      
      .fschat-send {
        padding: 4px 8px;
        font-size: 1rem;
        min-width: 32px;
      }
    }

    .fschat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      height: 64px;
      border-bottom: 1px solid #f0f0f0;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
      width: 100%;
      box-sizing: border-box;
    }

    .fschat-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      /* Allow flex items to shrink below content size */
      flex: 1;
      /* Take available space */
    }

    #closeFullscreenChat {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      /* Prevent button from shrinking */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    #fullscreenChatAvatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      /* Prevent avatar from shrinking */
    }

    #fullscreenChatTitle {
      font-size: 1.15rem;
      font-weight: 600;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      /* Allow text to shrink */
    }

    .fschat-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      /* Prevent right section from shrinking */
    }

    .fschat-balance {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      max-width: 120px;
      /* Limit balance width */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .fschat-menu-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .fschat-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 32px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
      min-width: 150px;
      max-width: 85vw;
      border: 1px solid #eee;
      overflow-x: auto;
      white-space: nowrap;
      z-index: 1000;
    }

    .fschat-menu.open {
      display: block;
    }

    .fschat-menu-btn {
      cursor: pointer;
      padding: 8px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      font-size: 20px;

      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }

    .fschat-menu-item {
      padding: 10px 16px;
      cursor: pointer;
    }

    .fschat-menu-item:hover {
      background: #f5f5f5;
    }

    .fschat-form {
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid #f0f0f0;
      background: #fff;
      padding: 12px 16px;
      position: sticky;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    #fullscreenChatInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1.08rem;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      /* Prevents flex item from overflowing */
    }

    .fschat-send {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 40px;
      height: 40px;
    }

    .fschat-send img {
      width: 24px;
      height: 24px;
      opacity: 0.7;
    }

    @media (max-width: 768px) {
      .fschat-header {
        padding: 0 12px;
      }

      .fschat-form {
        padding: 8px 12px;
        gap: 4px;
      }

      #fullscreenChatInput {
        padding: 8px 12px;
        font-size: 1rem;
      }

      .fschat-balance {
        padding: 6px 10px;
        font-size: 0.9rem;
        max-width: 100px;
      }

      .fschat-menu {
        min-width: 140px;
      }

      .fschat-menu-item {
        padding: 10px 14px;
        font-size: 0.95rem;
      }
    }

    @media (max-width: 320px) {
      .fschat-header {
        padding: 0 8px;
      }

      .fschat-form {
        padding: 6px 8px;
      }

      #fullscreenChatInput {
        padding: 6px 10px;
        font-size: 0.95rem;
      }

      .fschat-balance {
        padding: 4px 8px;
        font-size: 0.85rem;
        max-width: 80px;
      }

      #fullscreenChatAvatar {
        width: 32px;
        height: 32px;
      }

      #closeFullscreenChat {
        width: 28px;
        height: 28px;
        font-size: 1.3rem;
      }
    }

    .fschat-messages {
      flex: 1;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0 0 0;
    }

    .fschat-message {
      display: flex;
      gap: 12px;
      width: 100%;
      max-width: 800px;
      padding: 8px 16px;
      margin-bottom: 8px;
    }

    .fschat-message-me {
      flex-direction: row-reverse;
    }

    .fschat-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .fschat-message-content {
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 70%;
    }

    .fschat-message-me .fschat-message-content {
      background: #a020f0;
      color: #fff;
    }

    .fschat-message-nick {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #666;
    }

    .fschat-message-me .fschat-message-nick {
      color: #fff;
    }

    .fschat-message-text {
      font-size: 1rem;
      line-height: 1.4;
      word-break: break-word;
    }

    .fschat-bubble {
      background: #eaf7fd;
      color: #222;
      border-radius: 18px;
      padding: 12px 18px;
      font-size: 1.08rem;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .fschat-message.me .fschat-bubble {
      background: #fff;
      color: #222;
      border: 1px solid #eaf7fd;
    }

    .fschat-tip {
      color: #aaa;
      font-size: 0.98rem;
      text-align: center;
      margin: 0 0 8px 0;
    }

    .fschat-form {
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid #f0f0f0;
      background: #fff;
      padding: 12px 24px;
      position: sticky;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    #fullscreenChatInput {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1.08rem;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      /* Prevents flex item from overflowing */
    }

    .fschat-emoji {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: #888;
    }

    .fschat-send {
      background: #a020f0;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 1.3rem;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      flex-shrink: 0;
      /* Prevents button from shrinking */
      min-width: 40px;
      /* Minimum width for the button */
    }

    .fschat-send:hover {
      background: #9900ff;
    }

    @media (max-width: 768px) {
      .fschat-form {
        padding: 8px 12px;
        gap: 4px;
      }

      #fullscreenChatInput {
        padding: 8px 12px;
        font-size: 1rem;
      }

      .fschat-send {
        padding: 6px 12px;
        font-size: 1.1rem;
      }

      .fschat-menu {
        min-width: 150px;
        max-width: 85vw;
      }

      .fschat-menu-item {
        padding: 10px 14px;
        font-size: 0.95rem;
        white-space: nowrap;
      }
    }

    .fschat-menu-wrap {
      position: relative;
      flex-shrink: 0;
      /* Prevents menu from shrinking */
    }

    .fschat-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 32px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
      min-width: 180px;
      border: 1px solid #eee;
      max-width: 90vw;
      /* Limits menu width on mobile */
      overflow-x: auto;
      /* Allows horizontal scrolling if needed */
    }

    @media (max-width: 768px) {
      .fschat-form {
        padding: 8px 12px;
        gap: 4px;
      }

      #fullscreenChatInput {
        padding: 8px 12px;
        font-size: 1rem;
      }

      .fschat-send {
        padding: 6px 12px;
        font-size: 1.1rem;
      }

      .fschat-menu {
        min-width: 150px;
        max-width: 85vw;
      }

      .fschat-menu-item {
        padding: 10px 14px;
        font-size: 0.95rem;
        white-space: nowrap;
      }
    }

    .fschat-img-btn {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: #888;
    }

    .fschat-img-btn:hover {
      color: #a020f0;
    }

    .fschat-img-preview {
      max-width: 180px;
      max-height: 120px;
      border-radius: 10px;
      margin: 6px 0;
      display: block;
    }

    /* --- Wallet profile styles --- */
    .wallet-profile-block {
      background: #fff;
      border-radius: 18px;
      margin: 0 auto 32px auto;
      max-width: 700px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
      padding: 32px 32px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .wallet-profile-header {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .wallet-profile-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
    }

    .wallet-profile-info {
      flex: 1;
    }

    .wallet-profile-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #222;
    }

    .wallet-profile-handle {
      color: #aaa;
      font-size: 1.05rem;
      margin-left: 8px;
    }

    .wallet-profile-addr {
      color: #888;
      font-size: 1.05rem;
      margin: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .wallet-copy-btn {
      padding: 8px 8px !important;
      font-size: 0.85em;
      background: rgba(0, 0, 0, 0.1);
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .wallet-disconnect-btn {
      margin-right: 2px;
      padding: 8px 8px !important;
      font-size: 0.85em;
      background: rgba(0, 0, 0, 0.1);
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .wallet-profile-twitter {
      color: #a020f0;
      font-size: 1.05rem;
      margin-bottom: 2px;
    }

    .wallet-profile-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .wallet-profile-btn {
      background: #fff;
      color: #a020f0;
      border: 1px solid #a020f0;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .wallet-profile-btn:hover {
      background: #eaf7fd;
    }

    .wallet-profile-balances {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .wallet-profile-fees {
      color: #888;
      font-size: 1.05rem;
    }

    .wallet-profile-fee-val {
      color: #a020f0;
      font-weight: 600;
      margin-left: 6px;
    }

    .wallet-profile-balance-row {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .wallet-profile-balance {
      color: #a020f0;
      font-weight: 600;
      margin-left: 6px;
    }

    .wallet-profile-withdraw {
      background: #eaf7fd;
      color: #a020f0;
      border: none;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-left: auto;
      transition: background 0.2s;
    }

    .wallet-profile-withdraw:hover {
      background: #a020f0;
      color: #fff;
    }

    .wallet-profile-fund-label {
      color: #888;
      font-size: 1.05rem;
      margin-top: 12px;
    }

    .wallet-profile-fund-row {
      display: flex;
      gap: 12px;
      margin: 8px 0 0 0;
    }

    .wallet-fund-btn {
      flex: 1;
      font-size: 1.15rem;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      padding: 14px 0;
      cursor: pointer;
      margin: 0;
      transition: background 0.2s, color 0.2s;
    }

    .wallet-fund-base {
      background: #0052ff;
      color: #fff;
    }

    .wallet-fund-coinbase {
    
      color: #fff;
    }

    .wallet-fund-eth {
      background: #eee;
      color: #222;
    }

    .wallet-fund-btn:hover {
      filter: brightness(0.95);
    }

    .wallet-logout-btn {
      margin: 24px auto 0 auto;
      display: block;
      background: #fff;
      color: #888;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      padding: 10px 0;
      width: 100%;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .wallet-logout-btn:hover {
      background: #f5f5f5;
      color: #222;
    }

    @media (max-width: 900px) {
      .wallet-profile-block {
        max-width: 99vw;
        padding: 18px 4vw 12px 4vw;
      }

      .wallet-profile-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .wallet-profile-actions {
        flex-direction: row;
        gap: 8px;
      }

      .wallet-profile-avatar {
        width: 48px;
        height: 48px;
      }
    }

    @media (max-width: 600px) {
      .wallet-profile-block {
        padding: 10px 2vw 8px 2vw;
      }

      .wallet-profile-header {
        gap: 8px;
      }

      .wallet-profile-avatar {
        width: 36px;
        height: 36px;
      }

      .wallet-profile-btn,
      .wallet-profile-withdraw,
      .wallet-fund-btn,
      .wallet-logout-btn {
        font-size: 0.98rem;
        padding: 8px 0;
      }

      .wallet-profile-fund-row {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* --- Login/Register switch styles --- */
    .login-switch-row {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin-top: 10px;
    }

    .login-switch-link {
      color: #a020f0;
      font-size: 0.98rem;
      text-decoration: none;
      cursor: pointer;
      transition: text-decoration 0.2s;
    }

    .login-switch-link:hover {
      text-decoration: underline;
    }

    /* Добавляем стили для hover эффекта */
    .fschat-emoji img:hover,
    .fschat-img-btn img:hover,
    .fschat-send img:hover {
      opacity: 1 !important;
    }

    /* Стили для панели эмодзи */
    .emoji-panel {
      position: absolute;
      bottom: 50px;
      left: 0;
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 8px;
      display: none;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      z-index: 1000;
    }

    .emoji-btn {
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .emoji-btn:hover {
      background-color: #f0f0f0;
    }

    .emoji-btn img {
      width: 20px;
      height: 20px;
      display: block;
    }

    /* --- Edit Profile Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #222;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 4px 8px;
    }

    .close-button:hover {
      color: #222;
    }

    .edit-profile-avatar-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
    }

    .edit-profile-avatar-container img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .edit-profile-avatar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .edit-profile-avatar-overlay:hover {
      opacity: 1;
    }

    .edit-profile-camera-icon {
      width: 32px;
      height: 32px;
      filter: invert(1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #666;
      font-size: 0.9rem;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      border-color: #a020f0;
      outline: none;
    }

    .save-profile-btn {
      width: 100%;
      padding: 14px;
      background: #a020f0;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .save-profile-btn:hover {
      background: #9900ff;
    }

    @media (max-width: 600px) {
      .modal-content {
        margin: 5% auto;
        padding: 16px;
      }

      .edit-profile-avatar-container {
        width: 100px;
        height: 100px;
      }
    }

    .blue-button {
      background: #a020f0;
      color: #fff;
    }

    .blue-text {
      color: #a020f0;
    }

    .blue-border {
      border: 2px solid #a020f0;
      background: #f5f0fa;
    }

    .blue-bg {
      background: #a020f0;
      color: #fff;
    }

    .blue-button:hover {
      background: #8a1fd0;
    }

    .blue-bg:hover {
      background: #8a1fd0;
    }

    .blue-bg-light {
      background: #f5f0fa;
      border-left: 4px solid #a020f0;
    }

    .wallet-fund-btn a {
      color: white !important;
      text-decoration: none !important;
    }

    .wallet-fund-btn a:hover {
      color: white !important;
      text-decoration: none !important;
    }

    .wallet-profile-twitter a {
      text-decoration: none !important;
    }

    .wallet-profile-twitter a:hover {
      text-decoration: none !important;
    }

    /* Notification popup styles */
    .notification-popup {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
    }

    .notification-popup.active {
      display: block;
    }

    .notification-header {
      padding: 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      font-size: 1.1rem;
      color: #222;
    }

    .notification-list {
      padding: 8px 0;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f5f5f5;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: #f9f9f9;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-empty {
      padding: 24px 16px;
      text-align: center;
      color: #888;
      font-size: 0.95rem;
    }

    .chat-bell {
      cursor: pointer;
      position: relative;
    }

    .chat-bell.has-notifications::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #a020f0;
      border-radius: 50%;
      border: 2px solid white;
    }

    /* --- Sidebar (drawer) for mobile --- */
    .sidebar-dim {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.25);
      transition: opacity 0.3s ease;
      opacity: 0;
    }

    .sidebar-dim.active {
      display: block;
      opacity: 1;
    }

    .sidebar {
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        transform: translateX(-100%);
        top: 0;
        height: 100vh;
        z-index: 1000;
        box-shadow: 2px 0 16px rgba(0, 0, 0, 0.08);
        background: #fff;
        width: 220px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 32px;
        transition: transform 0.3s ease;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .main-app {
        width: 100%;
        min-width: 0;
      }

      .main-content {
        padding: 12px 16px 0 16px;
        margin-left: 0 !important;
        width: 100% !important;
      }

      .mobile-menu-btn {
        display: flex;
        position: fixed;
        left: 0px;
        top: 0px;
        z-index: 1100;
        background: #fff;
        border: none;
        border-radius: 8px;
        width: 44px;
        height: 44px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        transition: transform 0.3s ease;
      }

      .mobile-menu-btn.open {
        transform: rotate(90deg);
      }
    }

    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none;
      }

      .sidebar-dim {
        display: none !important;
      }

      .sidebar {
        transform: none !important;
        position: relative;
        width: 180px;
        height: auto;
        box-shadow: none;
      }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const sidebar = document.querySelector('.sidebar');
      
      mobileMenuBtn.addEventListener('click', function () {
        this.classList.toggle('active');
        sidebar.classList.toggle('active');
      });

      // Close sidebar when clicking outside
      document.addEventListener('click', function (event) {
        if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
          sidebar.classList.remove('active');
          mobileMenuBtn.classList.remove('active');
        }
      });
    });
  </script>
</head>

<body>
  <button class="mobile-menu-btn">
    <img src="images/sidebar_icon.png" alt="Menu" style="width: 24px; height: 24px;">
  </button>
  <div class="sidebar-dim" id="sidebarDim"></div>
  <div class="container">
    <div class="content">
      <!-- SVG логотип -->
      <img src="images/logo2.png" class="logo" alt="logo">
      <h1><span class="purple">Mesh </span></h1>
      <p class="subtitle">precious spaces online and onchain</p>
      <button class="login-btn">Log in</button>
    </div>
    <div class="footer">

    </div>
  </div>
  <!-- Модальное окно -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2>Log in / Register</h2>
      <button class="twitter-btn" id="twitterLogin">Log in with Twitter</button>
      <div class="divider">or</div>
      <form id="registerForm">
        <input type="email" placeholder="Email" required>
        <input type="password" placeholder="Password" required>
        <button type="submit" class="register-btn">Register</button>
      </form>
      <form id="loginForm" style="display:none; margin-top: 8px;">
        <input type="email" placeholder="Email" required>
        <input type="password" placeholder="Password" required>
        <button type="submit" class="register-btn">Sign In</button>
      </form>
      <div class="login-switch-row">
        <a href="#" id="showLoginForm" class="login-switch-link">Already have an account? Sign in</a>
        <a href="#" id="showRegisterForm" class="login-switch-link" style="display:none;">No account? Register</a>
      </div>
    </div>
  </div>
  <!-- Wallet section (изначально скрыта) -->
  <div id="wallet" class="wallet-section" style="display:none;">
    <div class="wallet-header">
      <div>
        <div class="wallet-label">Wallet value</div>
        <div class="wallet-value">$0.0</div>
      </div>
      <div>
        <div class="wallet-label">$MESH price</div>
        <div class="wallet-post-price">$0.0</div>
      </div>
    </div>
    <div class="wallet-grid wallet-grid-3x2">
      <div class="wallet-item">

      </div>
      <div class="wallet-item">
        <img src="images/logo2.png" alt="MESH" class="wallet-icon" style="width:64px;">
        <div class="wallet-item-label">$MESH</div>
        <div class="wallet-item-value">0.0</div>
        <button class="wallet-btn">Buy/Sell</button>
      </div>
      <div class="wallet-item">

      </div>



    </div>
  </div>
  <!-- Main app layout (скрыт по умолчанию) -->
  <div id="main-app" class="main-app" style="display:none;">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <img src="images/logo2.png" width="52" height="52" alt="logo">
      </div>
      <div class="sidebar-menu">
        <div class="sidebar-item active" data-tab="wallet">Wallet</div>
        <div class="sidebar-item" data-tab="chat">Chat</div>
        <div class="sidebar-item" data-tab="discover">Discover</div>
        <a href="https://x.com/MeshClubs" target="_blank" class="sidebar-item" style="display: inline-block;">
          <img src="images/x_icon.png" alt="Twitter" style="width: 24px; height: 24px;">
        </a>
        <a href="https://t.me/MeshClubs" target="_blank" class="sidebar-item" style="display: inline-block;">
          <img src="images/tg_icon.png" alt="Telegram" style="width: 24px; height: 24px;">
        </a>
      </div>
    </div>
    <div class="main-content">
      <!-- Wallet tab -->
      <div id="tab-wallet" class="tab-content">
        <div class="wallet-profile-block">
          <div class="wallet-profile-header">
            <img class="wallet-profile-avatar" src="https://randomuser.me/api/portraits/men/35.jpg" alt="avatar">
            <div class="wallet-profile-info">
              <div class="wallet-profile-name">Smirnoff <span class="wallet-profile-handle"></span></div>
              <div class="wallet-profile-addr">
                <span id="walletAddress">
                  
                </span>
              </div>
              <div class="wallet-profile-twitter"><a href="#" style="color:#a020f0;"></a> <span
                  style="color:#a020f0;">✔️</span></div>
            </div>
            <div class="wallet-profile-actions">
              <button class="wallet-profile-btn edit-profile-trigger">Edit profile</button>
              <div id="twitterButtons">
                <!-- Twitter buttons will be dynamically inserted here -->
              </div>
            </div>
          </div>
          <div class="wallet-profile-balances">
            <div class="wallet-profile-fees">Trading fees earned <span class="wallet-profile-fee-val"><img
                  src="images/logo2.png" style="width:14px;height:14px;vertical-align:middle;margin-right:2px;">
                0.000</span></div>
            <div class="wallet-profile-balance-row">
              <div>Wallet balance <span class="wallet-profile-balance"><img src="images/logo2.png"
                    style="width:14px;height:14px;vertical-align:middle;margin-right:2px;"> 0.000</span></div>
            </div>
          </div>
          <div class="wallet-profile-fund-label">
            Fund your MESH from
          </div>
          <div class="wallet-profile-fund-row">
            <button class="wallet-fund-btn wallet-fund-coinbase">
              <a href="https://swap.pump.fun/?input=So11111111111111111111111111111111111111112&amp;output=Q3GoXRETCNMgj874FAuFkomvx18GmNGL7Ct2gWZpump"
                target="_blank" style="color:white;font-size:1em;"> <span style="font-size:0.9em;"></span> pumpswap</a>
            </button>
          </div>
          <button class="wallet-logout-btn">Log out</button>
        </div>
        <div class="wallet-header wallet-header-coins">
          <div>
            <div class="wallet-label">Wallet value</div>
            <div class="wallet-value">$0.0</div>
          </div>
          <div>
            <div class="wallet-label">$MESH price</div>
            <div class="wallet-post-price">$0.0</div>
          </div>
        </div>
        <div class="wallet-grid wallet-grid-3x2">
          <div class="wallet-item">

          </div>
          <div class="wallet-item">
            <img src="images/logo2.png" alt="MESH" class="wallet-icon" style="width:64px;">
            <div class="wallet-item-label">$MESH</div>
            <div class="wallet-item-value">0.0</div>
            <button class="wallet-btn">Buy/Sell</button>
          </div>
          <div class="wallet-item">

          </div>
          <div class="wallet-item">

          </div>


        </div>
      </div>
      <!-- Chat tab -->
      <div id="tab-chat" class="tab-content" style="display:none;">
        <div class="chat-header">
          <input class="chat-search" type="text" placeholder="Find friends or clubs...">
          <img class="chat-bell" src="images/notification.png" alt="notification"
            style="width:24px;height:24px;vertical-align:middle;">
          <div class="notification-popup">
            <div class="notification-header">Notifications</div>
            <div class="notification-list">
              <div class="notification-empty">No notifications</div>
            </div>
          </div>
        </div>
        <div class="chat-tabs">
          <button class="chat-tab active">My room</button>
          <button class="chat-tab" id="newClubBtn">New club</button>
        </div>
        <div class="chat-notify">
          <span>Stay up to date with MESH by turning on notifications</span>
          <button class="chat-notify-btn" id="notificationToggleBtn">Turn on</button>
        </div>
        <div class="chat-list">
          <div class="chat-item user-item" onclick="openFullscreenChat({
              avatar: this.querySelector('img').src,
              title: this.querySelector('.chat-name').textContent,
              clubId: 'user_' + this.querySelector('.chat-name').textContent
            })">
            <img src="images/avatar.png" alt="avatar" class="chat-avatar">
            <div class="chat-info">
              <div class="chat-name">sadasd</div>
              <div class="chat-msg">Click to start chatting</div>
            </div>
            <div class="chat-price">$0.00</div>
          </div>
        </div>
      </div>
      <!-- Discover tab -->
      <div id="tab-discover" class="tab-content" style="display:none; padding: 20px;">
        <div class="discover-tabs">
          <button class="discover-tab active" id="discoverRankingsBtn">Rankings</button>
          <button class="discover-tab" id="discoverRecentBtn">Recent</button>
        </div>
        <div id="discover-rankings" class="discover-list">
          <!-- Примерные данные, можно расширить -->
          <div class="discover-item" data-club="ZENAI">
            <div class="discover-rank">1</div>
            <img class="discover-avatar" src="images/ZENAI.png" alt="ZENAI">
            <div class="discover-info">
              <div class="discover-title">ZENAI</div>
              <div class="discover-desc">AI club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="KITTY">
            <div class="discover-rank">2</div>
            <img class="discover-avatar" src="images/KITTY.png" alt="KITTY">
            <div class="discover-info">
              <div class="discover-title">KITTY</div>
              <div class="discover-desc">Cat lovers</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="MADHOUSE">
            <div class="discover-rank">3</div>
            <img class="discover-avatar" src="images/MADHOUSE.png" alt="MADHOUSE">
            <div class="discover-info">
              <div class="discover-title">MADHOUSE</div>
              <div class="discover-desc">Madness club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="VLOGS">
            <div class="discover-rank">4</div>
            <img class="discover-avatar" src="images/VLOGS.png" alt="VLOGS">
            <div class="discover-info">
              <div class="discover-title">VLOGS</div>
              <div class="discover-desc">Video bloggers</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="GANTU">
            <div class="discover-rank">5</div>
            <img class="discover-avatar" src="images/GANTU.png" alt="GANTU">
            <div class="discover-info">
              <div class="discover-title">GANTU</div>
              <div class="discover-desc">GANTU project</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="MASK">
            <div class="discover-rank">6</div>
            <img class="discover-avatar" src="images/MASK.png" alt="MASK">
            <div class="discover-info">
              <div class="discover-title">MASK</div>
              <div class="discover-desc">MASK community</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="XAI41P">
            <div class="discover-rank">7</div>
            <img class="discover-avatar" src="images/XAI41P.png" alt="XAI41P">
            <div class="discover-info">
              <div class="discover-title">XAI41P</div>
              <div class="discover-desc">XAI41P club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="AuraFarm">
            <div class="discover-rank">8</div>
            <img class="discover-avatar" src="images/AuraFarm.png" alt="AuraFarm">
            <div class="discover-info">
              <div class="discover-title">AuraFarm</div>
              <div class="discover-desc">AuraFarm club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="DUPE">
            <div class="discover-rank">9</div>
            <img class="discover-avatar" src="images/DUPE.png" alt="DUPE">
            <div class="discover-info">
              <div class="discover-title">DUPE</div>
              <div class="discover-desc">DUPE club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <div class="discover-item" data-club="KOKOK">
            <div class="discover-rank">10</div>
            <img class="discover-avatar" src="images/KOKOK.png" alt="KOKOK">
            <div class="discover-info">
              <div class="discover-title">KOKOK</div>
              <div class="discover-desc">KOKOK club</div>
            </div>
            <div class="discover-price">Price: 0.0 $MESH</div>
          </div>
          <!-- ... ещё элементы ... -->
        </div>
        <div id="discover-recent" class="discover-list" style="display:none;">
          <div style="color:#888; font-size:1.1rem; margin:40px auto; text-align:center;">Recent clubs coming soon...</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Модалка для New club -->
  <div id="clubModal" class="modal">
    <div class="modal-content create-club-modal-content">
      <span class="close" id="closeClubModal">&times;</span>
      <h2 style="margin-top:0;">Create club</h2>
      <div class="create-club-form">
        <label class="create-club-photo-label">
          <input type="file" id="clubPhotoInput" accept="image/*" style="display:none;">
          <div id="clubPhotoPreview" class="create-club-photo-preview">Tap to add<br>photo</div>
        </label>
        <div class="create-club-row">
          <input type="text" id="clubNameInput" class="create-club-input" placeholder="Name">
          <input type="text" id="clubTickerInput" class="create-club-input" placeholder="$TICKER" maxlength="8"
            style="text-transform:uppercase;">
        </div>
          <textarea id="clubDescInput" class="create-club-input"
            placeholder="Add a description for your club (optional)" style="resize:none;"></textarea>
        <div class="create-club-section-label">Select price curve</div>
        <div class="create-club-curves">
          <div class="curve-option selected" data-curve="casual">
            <svg width="48" height="32">
              <polyline points="0,28 16,24 32,20 48,8" fill="none" stroke="#22c55e" stroke-width="3" />
            </svg>
            <div>Casual</div>
          </div>
          <div class="curve-option" data-curve="standard">
            <svg width="48" height="32">
              <polyline points="0,28 12,24 24,16 36,8 48,4" fill="none" stroke="#a855f7" stroke-width="3" />
            </svg>
            <div>Standard</div>
          </div>
          <div class="curve-option" data-curve="exclusive">
            <svg width="48" height="32">
              <polyline points="0,28 8,24 16,20 32,16 40,8 48,0" fill="none" stroke="#fbbf24" stroke-width="3" />
            </svg>
            <div>Exclusive</div>
          </div>
        </div>
        <div class="create-club-section-label" style="margin-top:18px;">Buy club keys</div>
        <div class="create-club-row">
            <input type="number" id="clubKeysInput" class="create-club-input" value="1" min="1" max="1"
              style="width:80px;" readonly>
          <div style="margin-left:12px; color:#888; font-size:0.98rem;">Become the owner of your club</div>
        </div>
        <div class="create-club-row" style="margin-top:8px; align-items:center;">
          <div style="color:#888; font-size:0.98rem;">You will spend:</div>
          <div style="margin-left:8px; color:#a020f0; font-weight:600; font-size:1.1rem;">--</div>
          <div style="margin-left:24px; color:#888; font-size:0.98rem;">Your balance:</div>
            <div id="clubWalletBalance" style="margin-left:8px; color:#a020f0; font-weight:600; font-size:1.1rem;">...
            </div>
            <button id="clubConnectWalletBtn" class="connect-wallet-btn"
              style="margin-left:auto; padding:8px 16px; font-size:0.95rem;">Connect wallet</button>
        </div>
        <button class="create-club-btn" id="createClubBtn">Approve spending $MESH</button>
        <div style="color:#aaa; font-size:0.95rem; margin-top:10px; text-align:center;">Once you create your club, you
          cannot change these details</div>
      </div>
    </div>
  </div>
  <!-- Модалка для чата клуба -->
  <div id="clubChatModal" class="modal">
    <div class="modal-content club-chat-modal-content">
      <span class="close" id="closeClubChatModal">&times;</span>
      <div class="club-chat-header">
        <img id="clubChatAvatar" class="club-chat-avatar" src="" alt="avatar">
        <span id="clubChatTitle" class="club-chat-title"></span>
      </div>
      <div id="clubChatMessages" class="club-chat-messages"></div>
      <form id="clubChatForm" class="club-chat-form">
        <input id="clubChatInput" type="text" placeholder="Write something..." autocomplete="off">
        <button type="submit" class="club-chat-send-btn">➤</button>
      </form>
    </div>
  </div>
  <!-- Модалка для кода доступа к Discover-чату -->
  <div id="discoverCodeModal" class="modal">
    <div class="modal-content" style="max-width:340px;">
      <span class="close" id="closeDiscoverCodeModal">&times;</span>
      <h2>Enter access code</h2>
      <input type="text" id="discoverCodeInput" placeholder="Access code"
        style="padding:10px; border-radius:6px; border:1px solid #ddd; width:95%; margin-bottom:12px; font-size:1rem;">
      <div id="discoverCodeError" style="color:#e00; font-size:0.98rem; min-height:22px; margin-bottom:8px;"></div>
      <button id="discoverCodeSubmit" class="wallet-btn" style="width:100%;">Enter</button>
    </div>
  </div>
  <!-- Фуллскрин чат -->
    <div id="chatBackdrop" class="chat-backdrop"></div>
  <div id="fullscreenChat" class="fullscreen-chat">
    <div class="fschat-header">
      <div class="fschat-header-left">
        <button id="closeFullscreenChat" class="fschat-back">&#8592;</button>
        <img id="fullscreenChatAvatar" class="fschat-avatar" src="" alt="avatar">
        <span id="fullscreenChatTitle" class="fschat-title"></span>
      </div>
            <div class="fschat-header-right">
          <button class="fschat-balance" title="Balance"><img src="images/logo2.png"
              style="width:18px;vertical-align:middle;margin-right:4px;">0.0</button>
          <div class="fschat-menu-wrap">
            <button class="fschat-menu-btn" title="Menu">⋮</button>
                      <div class="fschat-menu">
              <div class="fschat-menu-item" onclick="window.copyLink()">Copy chat link</div>
              <div class="fschat-menu-item">Delete chat</div>
              <div class="fschat-menu-item">Turn on notifications</div>
              <div class="fschat-menu-item">Pin to top of chat list</div>
            </div>
            <script>
              window.copyLink = function() {
                if (!currentClubKey) return;
                const link = window.location.origin + window.location.pathname + '?chat=' + encodeURIComponent(currentClubKey);
                const el = document.createElement('textarea');
                el.value = link;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                // Show feedback
                alert('Link copied to clipboard!');
                
                // Close menu
                const menu = document.querySelector('.fschat-menu');
                if (menu) menu.style.display = 'none';
              }
            </script>
        </div>
      </div>
    </div>
    <div id="fullscreenChatMessages" class="fschat-messages"></div>
      <div class="fschat-tip">Tip: Chat with your key holders here. They can see your messages and only you can see
        their
        messages.</div>
    <form id="fullscreenChatForm" class="fschat-form" style="position:relative;">
      <button type="button" class="fschat-emoji" style="background: none; border: none; padding: 0; cursor: pointer;">
        <img
          src="https://toppng.com/uploads/preview/font-emoji-svg-png-icon-free-download-389350-onlinewebfonts-play-button-image-11563230644rbzu7hlann.png"
          alt="emoji" style="width: 24px; height: 24px; opacity: 0.7;">
      </button>
      <div class="emoji-panel">
        <button type="button" class="emoji-btn" data-emoji="👍"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/thumbs-up_1f44d.png" alt="👍"></button>
        <button type="button" class="emoji-btn" data-emoji="❤️"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/red-heart_2764-fe0f.png" alt="❤️"></button>
        <button type="button" class="emoji-btn" data-emoji="😊"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/smiling-face-with-smiling-eyes_1f60a.png"
            alt="😊"></button>
        <button type="button" class="emoji-btn" data-emoji="🎉"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/party-popper_1f389.png" alt="🎉"></button>
        <button type="button" class="emoji-btn" data-emoji="👋"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/waving-hand_1f44b.png" alt="👋"></button>
        <button type="button" class="emoji-btn" data-emoji="🔥"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/fire_1f525.png" alt="🔥"></button>
        <button type="button" class="emoji-btn" data-emoji="😂"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/face-with-tears-of-joy_1f602.png" alt="😂"></button>
        <button type="button" class="emoji-btn" data-emoji="🤔"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/thinking-face_1f914.png" alt="🤔"></button>
        <button type="button" class="emoji-btn" data-emoji="✨"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/sparkles_2728.png" alt="✨"></button>
        <button type="button" class="emoji-btn" data-emoji="😍"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/smiling-face-with-heart-eyes_1f60d.png"
            alt="😍"></button>
        <button type="button" class="emoji-btn" data-emoji="🙌"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/raising-hands_1f64c.png" alt="🙌"></button>
        <button type="button" class="emoji-btn" data-emoji="💪"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/flexed-biceps_1f4aa.png" alt="💪"></button>
        <button type="button" class="emoji-btn" data-emoji="🎯"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/direct-hit_1f3af.png" alt="🎯"></button>
        <button type="button" class="emoji-btn" data-emoji="💯"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/hundred-points_1f4af.png" alt="💯"></button>
        <button type="button" class="emoji-btn" data-emoji="⭐"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/star_2b50.png" alt="⭐"></button>
        <button type="button" class="emoji-btn" data-emoji="💡"><img
            src="https://em-content.zobj.net/thumbs/120/apple/325/light-bulb_1f4a1.png" alt="💡"></button>
      </div>
      <button type="button" class="fschat-img-btn" id="fschatImgBtn"
        style="background: none; border: none; padding: 0; cursor: pointer;">
        <img src="https://static.thenounproject.com/png/1034957-200.png" alt="add image"
          style="width: 24px; height: 24px; opacity: 0.7;">
      </button>
      <input type="file" id="fschatImgInput" accept="image/*" style="display:none;">
      <input id="fullscreenChatInput" type="text" placeholder="Write something..." autocomplete="off"
        style="margin-left:8px;">
      <button type="submit" class="fschat-send" style="background: none; border: none; padding: 0; cursor: pointer;">
        <img src="https://static-00.iconduck.com/assets.00/send-icon-2048x2048-h9h456ci.png" alt="send"
          style="width: 24px; height: 24px; opacity: 0.7;">
      </button>
    </form>
  </div>
  <!-- Firebase App (core) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Access codes -->
  <script src="./access-codes.js"></script>

  <!-- Main app script -->
  <script>
    // Проверяем, не инициализирован ли уже Firebase
    if (!firebase.apps.length) {
      const firebaseConfig = {
        apiKey: "AIzaSyCuL4tpaSsw1ylXf2VZrQ1b_2t_Kxd97cI",
        authDomain: "post-ad037.firebaseapp.com",
        projectId: "post-ad037",
        storageBucket: "post-ad037.firebasestorage.app",
        messagingSenderId: "377312187432",
        appId: "1:377312187432:web:565f47c145e0e73ac0911d",
        measurementId: "G-T48NR3B9VW"
      };
      firebase.initializeApp(firebaseConfig);
    }

    // Initialize Storage


    const modal = document.getElementById('modal');
    const loginBtn = document.querySelector('.login-btn');
    const closeModal = document.getElementById('closeModal');
    const twitterLogin = document.getElementById('twitterLogin');
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const showLoginForm = document.getElementById('showLoginForm');
    const showRegisterForm = document.getElementById('showRegisterForm');

    loginBtn.onclick = () => { modal.style.display = 'flex'; }
    closeModal.onclick = () => { modal.style.display = 'none'; }
    window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; }

    // --- Firebase config (замените на свои значения) ---
    const firebaseConfig = {

      apiKey: "AIzaSyCuL4tpaSsw1ylXf2VZrQ1b_2t_Kxd97cI",

      authDomain: "post-ad037.firebaseapp.com",

      projectId: "post-ad037",

      storageBucket: "post-ad037.firebasestorage.app",

      messagingSenderId: "377312187432",

      appId: "1:377312187432:web:565f47c145e0e73ac0911d",

      measurementId: "G-T48NR3B9VW"

    };

    firebase.initializeApp(firebaseConfig);
    const provider = new firebase.auth.TwitterAuthProvider();

    twitterLogin.onclick = () => {
      firebase.auth().signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          alert('Добро пожаловать, ' + user.displayName + '!');
          modal.style.display = 'none';
          document.querySelector('.container').style.display = 'none';
          document.getElementById('wallet').style.display = 'none';
          document.getElementById('main-app').style.display = 'flex';
          showTab('chat');
        })
        .catch((error) => {
          alert('Ошибка авторизации: ' + error.message);
        });
    };

    registerForm.onsubmit = function (e) {
      e.preventDefault();
      const email = registerForm.querySelector('input[type="email"]').value;
      const password = registerForm.querySelector('input[type="password"]').value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Пользователь зарегистрирован и автоматически залогинен
          modal.style.display = 'none';
          document.querySelector('.container').style.display = 'none';
          document.getElementById('wallet').style.display = 'none';
          document.getElementById('main-app').style.display = 'flex';
          showTab('chat');
        })
        .catch((error) => {
          if (error.code === 'auth/email-already-in-use') {
            alert('Этот email уже зарегистрирован. Пожалуйста, войдите.');
            // Переключаем на форму входа и подставляем email
            registerForm.style.display = 'none';
            loginForm.style.display = '';
            showLoginForm.style.display = 'none';
            showRegisterForm.style.display = '';
            loginForm.querySelector('input[type="email"]').value = email;
            loginForm.querySelector('input[type="password"]').focus();
          } else {
            alert('Ошибка регистрации: ' + error.message);
          }
        });
    };

    // Переключение вкладок
    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById('tab-' + tab).style.display = 'block';
      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
      document.querySelector('.sidebar-item[data-tab="' + tab + '"]').classList.add('active');
      
      // Close sidebar on mobile when switching tabs
      if (window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        const sidebarDim = document.getElementById('sidebarDim');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        
        if (sidebar) {
          sidebar.classList.remove('mobile-open');
        }
        if (sidebarDim) {
          sidebarDim.classList.remove('active');
        }
        if (mobileMenuBtn) {
          mobileMenuBtn.classList.remove('open');
        }
      }
    }
    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.onclick = function () {
        showTab(this.getAttribute('data-tab'));
      };
    });

    // --- New club modal logic ---
    const newClubBtn = document.getElementById('newClubBtn');
    const clubModal = document.getElementById('clubModal');
    const closeClubModal = document.getElementById('closeClubModal');
    const clubCodeInput = document.getElementById('clubCodeInput');
    const clubCodeSubmit = document.getElementById('clubCodeSubmit');
    const clubCodeError = document.getElementById('clubCodeError');

    // Добавляем модальное окно для ввода кода
    const codeModal = document.createElement('div');
    codeModal.id = 'codeModal';
    codeModal.className = 'modal';
    codeModal.innerHTML = `
      <div class="modal-content" style="max-width:340px;">
        <span class="close" id="closeCodeModal">&times;</span>
        <h2>Enter access code</h2>
        <input type="text" id="accessCodeInput" placeholder="Access code" style="padding:10px; border-radius:6px; border:1px solid #ddd; width:100%; margin-bottom:12px; font-size:1rem;">
        <div id="accessCodeError" style="color:#e00; font-size:0.98rem; min-height:22px; margin-bottom:8px;"></div>
        <button id="accessCodeSubmit" class="wallet-btn" style="width:100%;">Enter</button>
      </div>
    `;
    document.body.appendChild(codeModal);

    // Обработчики для модального окна с кодом
    const closeCodeModal = document.getElementById('closeCodeModal');
    const accessCodeInput = document.getElementById('accessCodeInput');
    const accessCodeError = document.getElementById('accessCodeError');
    const accessCodeSubmit = document.getElementById('accessCodeSubmit');

    if (newClubBtn) {
      newClubBtn.onclick = function () {
        // Показываем сначала окно для ввода кода
        codeModal.style.display = 'flex';
        accessCodeInput.value = '';
        accessCodeError.textContent = '';
        accessCodeInput.focus();
        setTimeout(updateClubWalletBalance, 100); // обновить баланс после открытия
      };
    }

    if (closeCodeModal) {
      closeCodeModal.onclick = function () {
        codeModal.style.display = 'none';
      };
    }

    // Закрытие по клику вне модального окна
    window.addEventListener('click', function (e) {
      if (e.target === codeModal) {
        codeModal.style.display = 'none';
      }
      if (e.target === clubModal) {
        clubModal.style.display = 'none';
      }
    });

    if (accessCodeSubmit) {
      accessCodeSubmit.onclick = function () {
        const code = accessCodeInput.value.trim();
        // Use the separate AccessCodeHandler
        const validation = window.AccessCodeHandler ? 
                         window.AccessCodeHandler.validate(code) : 
                         { isValid: code === 'newcode' };
        
        if (validation.isValid) {
          accessCodeError.style.color = '#0a0';
          accessCodeError.textContent = 'Access granted!';
          
          setTimeout(() => {
            codeModal.style.display = 'none';
            accessCodeError.textContent = '';
            // Показываем модальное окно создания клуба
            clubModal.style.display = 'flex';
          }, 1000);
        } else {
          accessCodeError.style.color = '#e00';
          accessCodeError.textContent = 'Invalid code!';
        }
      };
    }

    if (closeClubModal) {
      closeClubModal.onclick = function () {
        clubModal.style.display = 'none';
      };
    }

    // --- Discover tab logic ---
    const discoverRankingsBtn = document.getElementById('discoverRankingsBtn');
    const discoverRecentBtn = document.getElementById('discoverRecentBtn');
    const discoverRankings = document.getElementById('discover-rankings');
    const discoverRecent = document.getElementById('discover-recent');
    
    if (discoverRankingsBtn && discoverRecentBtn) {
      discoverRankingsBtn.onclick = function () {
        discoverRankingsBtn.classList.add('active');
        discoverRecentBtn.classList.remove('active');
        discoverRankings.style.display = '';
        discoverRecent.style.display = 'none';
      };
      
      discoverRecentBtn.onclick = function () {
        discoverRecentBtn.classList.add('active');
        discoverRankingsBtn.classList.remove('active');
        discoverRankings.style.display = 'none';
        discoverRecent.style.display = '';
      };
    }

    // --- Firebase auto-login ---
    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        document.querySelector('.container').style.display = 'none';
        document.getElementById('wallet').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        showTab('chat');

        // Load saved profile data from localStorage first
        const savedProfile = localStorage.getItem(`user_profile_${user.uid}`);
        let profileData = null;
        
        console.log('=== Profile Loading Debug ===');
        console.log('User UID:', user.uid);
        console.log('Looking for key:', `user_profile_${user.uid}`);
        console.log('Raw saved profile:', savedProfile);
        
        if (savedProfile) {
          try {
            profileData = JSON.parse(savedProfile);
            console.log('Parsed profile data:', profileData);
            console.log('Profile displayName:', profileData.displayName);
            console.log('Profile handle:', profileData.handle);
            console.log('Profile photoURL:', profileData.photoURL);
          } catch (e) {
            console.error('Error parsing saved profile data:', e);
          }
        } else {
          console.log('No saved profile data found for user:', user.uid);
          
          // Let's also check what keys exist in localStorage
          console.log('All localStorage keys:');
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('user_profile_')) {
              console.log(`  ${key}: ${localStorage.getItem(key)}`);
            }
          }
        }
      } else {
        document.querySelector('.container').style.display = '';
        document.getElementById('wallet').style.display = 'none';
        document.getElementById('main-app').style.display = 'none';
        // Показываем только форму регистрации по умолчанию
        document.getElementById('registerForm').style.display = '';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('showLoginForm').style.display = '';
        document.getElementById('showRegisterForm').style.display = 'none';
      }
    });

    // --- Обработчик выхода из аккаунта ---
    const logoutBtn = document.querySelector('.wallet-logout-btn');
    if (logoutBtn) {
      logoutBtn.onclick = function () {
        firebase.auth().signOut()
          .then(() => {
            // Возвращаем на главный экран
            document.querySelector('.container').style.display = '';
            document.getElementById('wallet').style.display = 'none';
            document.getElementById('main-app').style.display = 'none';
            // Сбрасываем формы
            document.getElementById('registerForm').reset();
            document.getElementById('loginForm').reset();
            // Показываем форму регистрации
            document.getElementById('registerForm').style.display = '';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('showLoginForm').style.display = '';
            document.getElementById('showRegisterForm').style.display = 'none';
          })
          .catch((error) => {
            alert('Ошибка при выходе: ' + error.message);
          });
      };
    }

    // --- Логика переключения между регистрацией и входом ---
    // Повторные объявления переменных удалены, используем уже объявленные выше
    if (showLoginForm && showRegisterForm && registerForm && loginForm) {
      showLoginForm.onclick = function (e) {
        e.preventDefault();
        // Показываем модальное окно
        modal.style.display = 'flex';
        // Получаем email из формы регистрации, если есть
        const regEmail = registerForm.querySelector('input[type="email"]').value;
        registerForm.style.display = 'none';
        loginForm.style.display = '';
        showLoginForm.style.display = 'none';
        showRegisterForm.style.display = '';
        // Подставляем email, если был введён
        if (regEmail) {
          loginForm.querySelector('input[type="email"]').value = regEmail;
        }
        loginForm.querySelector('input[type="password"]').focus();
      };
      showRegisterForm.onclick = function (e) {
        e.preventDefault();
        registerForm.style.display = '';
        loginForm.style.display = 'none';
        showLoginForm.style.display = '';
        showRegisterForm.style.display = 'none';
        // Автофокус на email
        registerForm.querySelector('input[type="email"]').focus();
      };
    }
    // --- Вход через email/password ---
    loginForm.onsubmit = function (e) {
      e.preventDefault();
      const email = loginForm.querySelector('input[type="email"]').value;
      const password = loginForm.querySelector('input[type="password"]').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Скрываем модальное окно и начальный контейнер
          modal.style.display = 'none';
          document.querySelector('.container').style.display = 'none';
          // Скрываем кошелек
          document.getElementById('wallet').style.display = 'none';
          // Показываем основное приложение
          document.getElementById('main-app').style.display = 'flex';
          // Переключаемся на вкладку чата
          showTab('chat');
        })
        .catch((error) => {
          alert('Ошибка входа: ' + error.message);
        });
    };

    // Закрытие модалки Create club
    const closeCreateClubModal = document.getElementById('closeCreateClubModal');
    if (closeCreateClubModal) {
      closeCreateClubModal.onclick = function () {
        document.getElementById('createClubModal').style.display = 'none';
      };
    }

    // Загрузка и предпросмотр фото
    document.getElementById('clubPhotoPreview').onclick = function () {
      document.getElementById('clubPhotoInput').click();
    };

    document.getElementById('clubPhotoInput').onchange = function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          document.getElementById('clubPhotoPreview').innerHTML = '<img src="' + ev.target.result + '" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">';
        };
        reader.readAsDataURL(file);
      }
    };

    // Выбор кривой цены
    document.querySelectorAll('.curve-option').forEach(opt => {
      opt.onclick = function () {
        document.querySelectorAll('.curve-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
      };
    });

    // --- Клубы ---
    function getClubs() {
      try {
        return JSON.parse(localStorage.getItem('clubs') || '[]');
      } catch { return []; }
    }
    function saveClubs(clubs) {
      localStorage.setItem('clubs', JSON.stringify(clubs));
    }
    function renderClubs() {
      const chatList = document.querySelector('.chat-list');
      if (!chatList) return;
      // Оставляем только первый (примерный) чат
      const staticChat = chatList.querySelector('.chat-item');
      chatList.innerHTML = '';
      if (staticChat) chatList.appendChild(staticChat);
      const clubs = getClubs();
      clubs.forEach(club => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.innerHTML = `
          <img src="${club.avatar || 'https://via.placeholder.com/40x40?text=Club'}" class="chat-avatar" alt="avatar">
          <div class="chat-info">
            <div class="chat-name">${club.name} <span style='color:#a020f0;font-size:0.95em;'>${club.ticker ? ('(' + club.ticker + ')') : ''}</span></div>
            <div class="chat-msg" style="white-space:pre-line;">${club.desc || ''}</div>
          </div>
          <div class="chat-price">$0.00</div>
        `;
        chatList.appendChild(div);
      });
    }
    // При загрузке страницы
    renderClubs();

    // --- Обработка создания клуба ---
    document.getElementById('createClubBtn').onclick = function () {
      const name = document.getElementById('clubNameInput').value.trim();
      const ticker = document.getElementById('clubTickerInput').value.trim().toUpperCase();
      const desc = document.getElementById('clubDescInput').value.trim();
      const avatarEl = document.getElementById('clubPhotoPreview').querySelector('img');
      const avatar = avatarEl ? avatarEl.src : '';
      
      if (!name || !ticker) {
        alert('Name and ticker are required!');
        return;
      }

      // Check for duplicate name or ticker
      const clubs = getClubs();
      const isDuplicate = clubs.some(club => 
        club.name.toLowerCase() === name.toLowerCase() || 
        club.ticker.toUpperCase() === ticker.toUpperCase()
      );

      if (isDuplicate) {
        alert('A club with this name or ticker already exists!');
        return;
      }

      clubs.push({ name, ticker, desc, avatar });
      saveClubs(clubs);
      renderClubs();
        // Close the modal
        const modal = document.querySelector('.modal-content.create-club-modal-content').closest('.modal');
        if (modal) modal.style.display = 'none';
      // Сброс формы
      document.getElementById('clubNameInput').value = '';
      document.getElementById('clubTickerInput').value = '';
      document.getElementById('clubDescInput').value = '';
      document.getElementById('clubPhotoPreview').innerHTML = 'Tap to add<br>photo';
      document.getElementById('clubPhotoInput').value = '';
      document.querySelectorAll('.curve-option').forEach(o => o.classList.remove('selected'));
      document.querySelector('.curve-option[data-curve="casual"]').classList.add('selected');
    };

    // --- Открытие чата клуба ---
    let currentClubKey = null;
    document.querySelector('.chat-list').addEventListener('click', function (e) {
      let item = e.target;
      while (item && !item.classList.contains('chat-item')) item = item.parentElement;
      if (!item) return;
      // Пропускаем первый (статичный) чат
      const idx = Array.from(this.children).indexOf(item);
      if (idx === 0) return;
      const clubs = getClubs();
      const club = clubs[idx - 1];
      if (!club) return;
      currentClubKey = club.name + '|' + club.ticker;
      window.location.href = `/chat.html?chat=${encodeURIComponent(currentClubKey)}`;
    });

    // --- Открытие чата из Discover с кодом ---
    let discoverChatData = null;
    document.getElementById('discover-rankings').addEventListener('click', function (e) {
      let item = e.target;
      while (item && !item.classList.contains('discover-item')) item = item.parentElement;
      if (!item) return;
      const avatar = item.querySelector('.discover-avatar')?.src || '';
      const name = item.querySelector('.discover-title')?.textContent || '';
      const ticker = (item.querySelector('.discover-title')?.textContent.match(/\(([^)]+)\)/) || [])[1] || '';
      const chatId = 'discover|' + name + '|' + ticker;

      // Проверяем, есть ли доступ у текущего пользователя к конкретному клубу
      const currentUser = firebase.auth().currentUser;
      if (currentUser) {
        const clubAccessKey = `club_access_${currentUser.uid}_${name.trim()}`;
        const hasAccess = localStorage.getItem(clubAccessKey) === 'true';

        if (hasAccess) {
          // Если доступ к этому клубу уже есть, сразу открываем чат
          window.location.href = `/chat.html?chat=${encodeURIComponent(chatId)}`;
        } else {
          // Если доступа к этому клубу нет, показываем окно для ввода кода
          document.getElementById('discoverCodeModal').style.display = 'flex';
          document.getElementById('discoverCodeInput').value = '';
          document.getElementById('discoverCodeError').textContent = '';
          document.getElementById('discoverCodeInput').focus();
        }
      } else {
        // Если пользователь не авторизован, показываем окно для ввода кода
        document.getElementById('discoverCodeModal').style.display = 'flex';
        document.getElementById('discoverCodeInput').value = '';
        document.getElementById('discoverCodeError').textContent = '';
        document.getElementById('discoverCodeInput').focus();
      }
    });

    document.getElementById('closeDiscoverCodeModal').onclick = function () {
      document.getElementById('discoverCodeModal').style.display = 'none';
    };

    document.getElementById('discoverCodeSubmit').onclick = function () {
      const code = document.getElementById('discoverCodeInput').value.trim();
      if (code) {
        document.getElementById('discoverCodeError').style.color = 'red';
        document.getElementById('discoverCodeError').textContent = 'Access denied!';

        // Сохраняем информацию о доступе для текущего пользователя к конкретному клубу
        const currentUser = firebase.auth().currentUser;
        if (currentUser && discoverChatData) {
          const clubName = discoverChatData.title.split('(')[0].trim();
          const clubAccessKey = `club_access_${currentUser.uid}_${clubName}`;
          localStorage.setItem(clubAccessKey, 'true');
        }

                  setTimeout(() => {
          document.getElementById('discoverCodeModal').style.display = 'none';
          const chatId = 'discover|' + name + '|' + ticker;
          window.location.href = `/chat.html?chat=${encodeURIComponent(chatId)}`;
        }, 700);
      } else {
        document.getElementById('discoverCodeError').style.color = '#e00';
        document.getElementById('discoverCodeError').textContent = 'Invalid code!';
      }
    };

    // Copy chat link functionality
    function copyCurrentChatLink() {
      if (!currentClubKey) return;
      
      // Create the chat link
      const baseUrl = window.location.origin + window.location.pathname;
      const chatLink = `${baseUrl}?chat=${encodeURIComponent(currentClubKey)}`;
      
      // Copy to clipboard
      navigator.clipboard.writeText(chatLink).then(() => {
        // Show success feedback
        const balanceBtn = document.querySelector('.fschat-balance');
        const originalContent = balanceBtn.innerHTML;
        balanceBtn.innerHTML = '✓ Link copied!';
        
        // Restore original content after 2 seconds
        setTimeout(() => {
          balanceBtn.innerHTML = originalContent;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy link. Please try again.');
      });
    }

    // --- Web3 Chat: меню ---
    (function () {
      const menuBtn = document.querySelector('.fschat-menu-btn');
      const menuWrap = document.querySelector('.fschat-menu-wrap');
      const menu = document.querySelector('.fschat-menu');
      const menuItems = document.querySelectorAll('.fschat-menu-item');
      
      if (menuBtn && menuWrap && menu) {
        menuBtn.addEventListener('click', function(e) {
          // Якщо це клік для копіювання посилання, не відкриваємо меню
          if (e.target.hasAttribute('onclick')) return;
          
          e.stopPropagation();
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });
        
        document.body.addEventListener('click', function () {
          menuWrap.classList.remove('open');
        });

        // Handle menu items
        menuItems.forEach(item => {
            item.onclick = function (e) {
            e.stopPropagation();
            const action = this.textContent.trim();
            
              switch (action) {
              case 'Delete chat':
                if (confirm('Are you sure you want to delete this chat?')) {
                  // Remove chat from localStorage
                  localStorage.removeItem('clubmsg_' + currentClubKey);
                  // Remove from clubs list
                  const clubs = getClubs();
                  const clubName = document.getElementById('fullscreenChatTitle').textContent.split('(')[0].trim();
                  const updatedClubs = clubs.filter(club => club.name !== clubName);
                  saveClubs(updatedClubs);
                  // Close chat and update list
                  document.getElementById('fullscreenChat').style.display = 'none';
                  document.querySelector('.main-app').style.display = 'flex';
                  renderClubs();
                }
                break;
                
              case 'Turn on notifications':
                if ('Notification' in window) {
                  Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                      // Save notification preference
                      const clubName = document.getElementById('fullscreenChatTitle').textContent.split('(')[0].trim();
                      localStorage.setItem('notify_' + clubName, 'true');
                      this.textContent = 'Turn off notifications';
                    }
                  });
                }
                break;
                
              case 'Turn off notifications':
                const clubName = document.getElementById('fullscreenChatTitle').textContent.split('(')[0].trim();
                localStorage.removeItem('notify_' + clubName);
                this.textContent = 'Turn on notifications';
                break;
                
              case 'Pin to top of chat list':
                const clubs = getClubs();
                const currentClub = clubs.find(club => 
                  club.name === document.getElementById('fullscreenChatTitle').textContent.split('(')[0].trim()
                );
                
                if (currentClub) {
                  // Remove from current position
                  const filteredClubs = clubs.filter(club => club.name !== currentClub.name);
                  // Add to beginning
                  filteredClubs.unshift(currentClub);
                  saveClubs(filteredClubs);
                  renderClubs();
                }
                break;
            }
            
            menuWrap.classList.remove('open');
          };
        });
      }
    })();

    // Copy chat link functionality
    function copyCurrentChatLink() {
      if (!currentClubKey) return;
      
      // Create the chat link
      const baseUrl = window.location.origin + window.location.pathname;
      const chatLink = `${baseUrl}?chat=${encodeURIComponent(currentClubKey)}`;
      
      // Copy to clipboard
      navigator.clipboard.writeText(chatLink).then(() => {
        // Show success feedback
        const balanceBtn = document.querySelector('.fschat-balance');
        const originalContent = balanceBtn.innerHTML;
        balanceBtn.innerHTML = '✓ Link copied!';
        
        // Restore original content after 2 seconds
        setTimeout(() => {
          balanceBtn.innerHTML = originalContent;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy link. Please try again.');
      });
    }

    // --- Web3 Chat: открытие и закрытие ---
    document.getElementById('closeFullscreenChat').onclick = function() {
      const fullscreenChat = document.getElementById('fullscreenChat');
      const backdrop = document.getElementById('chatBackdrop');
      backdrop.style.display = 'none';
      fullscreenChat.style.display = 'none';
      document.querySelector('.main-app').style.display = 'flex';
      currentClubKey = null;
    };

    // Menu functionality
    (function() {
      const menuBtn = document.querySelector('.fschat-menu-btn');
      const menu = document.querySelector('.fschat-menu');
      
      if (menuBtn && menu) {
        menuBtn.onclick = function(e) {
          e.stopPropagation();
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };
        
        document.addEventListener('click', function(e) {
          if (!menu.contains(e.target) && e.target !== menuBtn) {
            menu.style.display = 'none';
          }
        });
      }
    })();

    // Copy chat link functionality
    function copyCurrentChatLink(event) {
      event.preventDefault();
      event.stopPropagation();
      
      if (!currentClubKey) return;
      
      // Create the chat link
      const baseUrl = window.location.origin + window.location.pathname;
      const chatLink = `${baseUrl}?chat=${encodeURIComponent(currentClubKey)}`;
      
      // Create temporary input element
      const tempInput = document.createElement('input');
      tempInput.style.position = 'fixed';
      tempInput.style.opacity = 0;
      tempInput.value = chatLink;
      document.body.appendChild(tempInput);
      
      // Select and copy
      tempInput.select();
      tempInput.setSelectionRange(0, 99999); // For mobile devices
      
      try {
        document.execCommand('copy');
        
        // Show success message
        const tooltip = document.createElement('div');
        tooltip.textContent = 'Link copied!';
        tooltip.style.cssText = `
          position: fixed;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 8px 12px;
          border-radius: 4px;
          font-size: 14px;
          z-index: 10000;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        `;
        
        document.body.appendChild(tooltip);
        
        // Remove tooltip after animation
        setTimeout(() => {
          tooltip.style.opacity = '0';
          tooltip.style.transition = 'opacity 0.3s ease';
          setTimeout(() => document.body.removeChild(tooltip), 300);
        }, 1500);
        
        // Close menu
        const menu = document.querySelector('.fschat-menu');
        if (menu) menu.style.display = 'none';
      } catch (err) {
        console.error('Copy failed:', err);
        alert('Failed to copy link. Please try again.');
      }
      
      // Cleanup
      document.body.removeChild(tempInput);
    }
    
    function showCopySuccess() {
      // Create and show tooltip
      const tooltip = document.createElement('div');
      tooltip.textContent = 'Link copied!';
      tooltip.style.cssText = `
        position: fixed;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10000;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      `;
      
      document.body.appendChild(tooltip);
      
      // Remove tooltip after animation
      setTimeout(() => {
        tooltip.style.opacity = '0';
        tooltip.style.transition = 'opacity 0.3s ease';
        setTimeout(() => document.body.removeChild(tooltip), 300);
      }, 1500);
    }

    function openFullscreenChat({ avatar, title, clubId }) {
      const fullscreenChat = document.getElementById('fullscreenChat');
      const backdrop = document.getElementById('chatBackdrop');
      
      // Set chat data
      document.getElementById('fullscreenChatAvatar').src = avatar;
      document.getElementById('fullscreenChatTitle').textContent = title;
      fullscreenChat.setAttribute('data-club', clubId);
      
      // Show chat
      backdrop.style.display = 'block';
      fullscreenChat.style.display = 'flex';
      document.querySelector('.main-app').style.display = 'none';
      
      // Load messages
      currentClubKey = clubId;
      renderFullscreenChatMessages();
      updateBalanceDisplay();
      
      // Focus input
      document.getElementById('fullscreenChatInput').focus();
      fullscreenChat.setAttribute('data-club', clubId);
      document.getElementById('fullscreenChatAvatar').src = avatar;
      document.getElementById('fullscreenChatTitle').textContent = title;
      currentClubKey = clubId;
      renderFullscreenChatMessages();
      fullscreenChat.style.display = 'flex';
        backdrop.style.display = 'block';
      document.querySelector('.main-app').style.display = 'none';
      updateChatBalance(clubId, 0); // Синхронизируем баланс без инкремента

        // Initialize chat if it's a new conversation
        if (!getClubMessages(clubId).length) {
          saveClubMessages(clubId, []);
        }

      setTimeout(() => {
        const msgBox = document.getElementById('fullscreenChatMessages');
        msgBox.scrollTop = msgBox.scrollHeight;
      }, 100);
    }
      function closeChat() {
      document.getElementById('fullscreenChat').style.display = 'none';
        document.getElementById('chatBackdrop').style.display = 'none';
      document.querySelector('.main-app').style.display = 'flex';
      }

      document.getElementById('closeFullscreenChat').onclick = closeChat;
      document.getElementById('chatBackdrop').onclick = closeChat;
    function getClubMessages(clubId) {
      try {
        return JSON.parse(localStorage.getItem('clubmsg_' + clubId) || '[]');
      } catch { return []; }
    }
    function saveClubMessages(clubId, msgs) {
      localStorage.setItem('clubmsg_' + clubId, JSON.stringify(msgs));
    }
    // --- Web3 Chat: сообщения ---
    const demoUsers = [
      { nick: 'Exo', avatar: 'https://randomuser.me/api/portraits/men/32.jpg' },
      { nick: '#roc', avatar: 'https://randomuser.me/api/portraits/men/33.jpg' },
      { nick: 'Gamb', avatar: 'https://randomuser.me/api/portraits/men/34.jpg' },
      { nick: 'Smiroff', avatar: 'https://randomuser.me/api/portraits/men/35.jpg' }
    ];

    // Chat balance management
    function getChatBalance(clubId) {
      try {
        return parseFloat(localStorage.getItem('chat_balance_' + clubId) || '0');
      } catch { return 0; }
    }

    function updateChatBalance(clubId, increment = 0.1) {
      console.log('🔁 Updating club:', clubId);
      
      const currentBalance = getChatBalance(clubId);
      const newBalance = currentBalance + increment;
      localStorage.setItem('chat_balance_' + clubId, newBalance.toString());
      
      // Update discover item price if it exists
      const discoverItem = document.querySelector(`.discover-item[data-club="${clubId}"]`);
      if (discoverItem) {
        const priceEl = discoverItem.querySelector('.discover-price');
        if (priceEl) {
          priceEl.textContent = `Price: ${newBalance.toFixed(1)} $MESH`;
          console.log('✅ Updated discover-price:', priceEl.textContent);
        }
      }

      // Update fschat-balance if it exists
      const fschat = document.querySelector(`.fschat[data-club="${clubId}"]`);
      if (fschat) {
        const balanceEl = fschat.querySelector('.fschat-balance');
        if (balanceEl) {
          balanceEl.innerHTML = `<img src="images/logo2.png" style="width:18px;vertical-align:middle;margin-right:4px;">${newBalance.toFixed(1)}`;
          console.log('✅ Updated fschat-balance:', balanceEl.textContent);
        }
      }
      
      return newBalance;
    }

    function updateBalanceDisplay() {
      if (!currentClubKey) return;
      const balance = getChatBalance(currentClubKey);
      const balanceEl = document.querySelector('.fschat-balance');
      if (balanceEl) {
        balanceEl.innerHTML = `<img src="images/logo2.png" style="width:18px;vertical-align:middle;margin-right:4px;">${balance.toFixed(1)}`;
      }
    }

    function renderFullscreenChatMessages() {
      const box = document.getElementById('fullscreenChatMessages');
      box.innerHTML = '';
      if (!currentClubKey) return;
      let msgs = getClubMessages(currentClubKey);
      // Если сообщений нет, ничего не показываем
      if (!msgs.length) {
        return;
      }
      msgs.forEach((m, i) => {
        const currentUser = firebase.auth().currentUser;
        const isMe = (m.user === 3) || (!m.user && m.nick === 'Smiroff') || (m.uid === currentUser?.uid);
        let userAvatar, userNick;
        
        if (m.user === 3 || m.uid === currentUser?.uid) {
          userAvatar = currentUser?.photoURL || 'https://e7.pngegg.com/pngimages/178/595/png-clipart-user-profile-computer-icons-login-user-avatars-monochrome-black-thumbnail.png';
          userNick = currentUser?.displayName || 'You';
        } else {
          const demoUser = demoUsers[m.user % demoUsers.length];
          userAvatar = demoUser.avatar;
          userNick = demoUser.nick;
        }
        
        const div = document.createElement('div');
        div.className = `fschat-message ${isMe ? 'fschat-message-me' : ''}`;
        div.innerHTML = `
          <img src="${userAvatar}" class="fschat-message-avatar" alt="avatar">
          <div class="fschat-message-content">
            <div class="fschat-message-nick">${userNick}</div>
            <div class="fschat-message-text">${m.text}</div>
          </div>
        `;
        box.appendChild(div);
      });
    }

    // Handle chat form submission
      document.getElementById('fullscreenChatForm').onsubmit = function (e) {
      e.preventDefault();
      const input = document.getElementById('fullscreenChatInput');
      const text = input.value.trim();
      if (!text || !currentClubKey) return;
      
      // Get current messages
      let msgs = getClubMessages(currentClubKey);
      
      // Add new message
      const currentUser = firebase.auth().currentUser;
      msgs.push({
        text,
        user: 3,
        uid: currentUser?.uid,
        nick: currentUser?.displayName,
        time: new Date().toISOString()
      });
      
      // Save messages
      saveClubMessages(currentClubKey, msgs);
      
      // Update balance
      updateChatBalance(currentClubKey);
      
      // Update display
      renderFullscreenChatMessages();
      updateBalanceDisplay();
      
      // Clear input
      input.value = '';
      
      // Scroll to bottom
      const msgBox = document.getElementById('fullscreenChatMessages');
      msgBox.scrollTop = msgBox.scrollHeight;
    };

    // --- Emoji panel logic ---
    const chatEmojiPanel = document.getElementById('fschatEmojiPanel');
    const emojiBtn = document.querySelector('.fschat-emoji');
    const chatInput = document.getElementById('fullscreenChatInput');
    const emojiList = [
      '☺', '☻', '♡', '♥', '☀', '☁', '★', '☆', '☮', '☯', '☎', '⌨', '✉', '☑', '✓', '✔', '×', '≠', '∞', '♪', '♫', '⌘', '⌥', '⌦', '↵', '⇧', '⇪', '○', '◎', '●', '◐', '◑', '◒', '◓', '◌', '◍', '◉', '◊', '☘', '♣', '♠', '♦', '⚡', '☕', '✎', '✏', '✐', '✑', '✒', '✍', '✌', '⭐'
    ];
    emojiBtn.onclick = function (e) {
      e.preventDefault();
      chatEmojiPanel.innerHTML = '';
      emojiList.forEach(em => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'fschat-emoji-btn';
        btn.textContent = em;
        btn.onclick = function (ev) {
          ev.preventDefault();
          chatInput.value += em;
          chatEmojiPanel.style.display = 'none';
          chatInput.focus();
        };
        chatEmojiPanel.appendChild(btn);
      });
      chatEmojiPanel.style.display = chatEmojiPanel.style.display === 'none' ? 'flex' : 'none';
    };
    document.body.addEventListener('click', function (e) {
        if (chatEmojiPanel && !chatEmojiPanel.contains(e.target) && e.target !== emojiBtn) {
          chatEmojiPanel.style.display = 'none';
        }
    });

    // --- Image upload logic ---
    const imgBtn = document.getElementById('fschatImgBtn');
    const imgInput = document.getElementById('fschatImgInput');
    let imgToSend = null;
    imgBtn.onclick = function (e) {
      e.preventDefault();
      imgInput.click();
    };
    imgInput.onchange = function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          imgToSend = ev.target.result;
          // Показываем превью
          if (!document.getElementById('fschatImgPreview')) {
            const preview = document.createElement('img');
            preview.id = 'fschatImgPreview';
            preview.className = 'fschat-img-preview';
            preview.src = imgToSend;
            chatInput.parentNode.insertBefore(preview, chatInput);
          } else {
            document.getElementById('fschatImgPreview').src = imgToSend;
          }
        };
        reader.readAsDataURL(file);
      }
    };
    // Удалять превью при отправке или очистке
    function clearImgPreview() {
      imgToSend = null;
      const prev = document.getElementById('fschatImgPreview');
      if (prev) prev.remove();
      imgInput.value = '';
    }
    // --- Переключение между регистрацией и входом (как на friends-sand.vercel.app) ---
    (function () {
      const showLoginForm = document.getElementById('showLoginForm');
      const showRegisterForm = document.getElementById('showRegisterForm');
      const registerForm = document.getElementById('registerForm');
      const loginForm = document.getElementById('loginForm');
      if (showLoginForm && showRegisterForm && registerForm && loginForm) {
        showLoginForm.onclick = function (e) {
          e.preventDefault();
          registerForm.style.display = 'none';
          loginForm.style.display = '';
          showLoginForm.style.display = 'none';
          showRegisterForm.style.display = '';
          loginForm.querySelector('input[type="email"]').focus();
        };
        showRegisterForm.onclick = function (e) {
          e.preventDefault();
          registerForm.style.display = '';
          loginForm.style.display = 'none';
          showLoginForm.style.display = '';
          showRegisterForm.style.display = 'none';
          registerForm.querySelector('input[type="email"]').focus();
        };
      }
    })();
    // --- Конец блока переключения ---

    // Добавляем JavaScript для работы с эмодзи
    document.addEventListener('DOMContentLoaded', function () {
      const emojiButton = document.querySelector('.fschat-emoji');
      const emojiPanel = document.querySelector('.emoji-panel');
      const chatInput = document.getElementById('fullscreenChatInput');

      // Показать/скрыть панель эмодзи при клике на кнопку
      emojiButton.addEventListener('click', function (e) {
        e.stopPropagation();
        emojiPanel.style.display = emojiPanel.style.display === 'grid' ? 'none' : 'grid';
      });

      // Добавить эмодзи в поле ввода при клике
      document.querySelectorAll('.emoji-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          const emoji = this.getAttribute('data-emoji');
          const start = chatInput.selectionStart;
          const end = chatInput.selectionEnd;
          const text = chatInput.value;
          chatInput.value = text.substring(0, start) + emoji + text.substring(end);
          chatInput.focus();
          chatInput.selectionStart = chatInput.selectionEnd = start + emoji.length;
        });
      });

      // Закрыть панель при клике вне её
      document.addEventListener('click', function (e) {
        if (!emojiPanel.contains(e.target) && e.target !== emojiButton) {
          emojiPanel.style.display = 'none';
        }
      });
    });

 

    // Функция для генерации адреса кошелька
    function generateWalletAddress() {
      const chars = '0123456789abcdef';
      let address = '0x';
      // Генерируем 40 символов (20 байт) для адреса Ethereum
      for (let i = 0; i < 40; i++) {
        address += chars[Math.floor(Math.random() * chars.length)];
      }
      return address;
    }

    // Функция для сокращения адреса (показывает первые 6 и последние 4 символа)
    function shortenAddress(address) {
      return address.slice(0, 6) + '...' + address.slice(-4);
    }

    // Функция обновления адреса в профиле
    function updateProfileAddress(user) {
      const addressElement = document.querySelector('.wallet-profile-addr');
      if (!addressElement) return;

      // Получаем сохраненный адрес или генерируем новый
      let walletAddress = localStorage.getItem(`wallet_address_${user.uid}`);
      if (!walletAddress) {
        walletAddress = generateWalletAddress();
        localStorage.setItem(`wallet_address_${user.uid}`, walletAddress);
      }

      // Обновляем отображение
      const shortenedAddress = shortenAddress(walletAddress);
      renderWalletAddress();


    }

    // Обновляем обработчик авторизации
    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        document.querySelector('.container').style.display = 'none';
        document.getElementById('wallet').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        showTab('chat');

        // Обновляем аватар пользователя
        const profileAvatar = document.querySelector('.wallet-profile-avatar');
        if (profileAvatar) {
          profileAvatar.src = user.photoURL || 'https://e7.pngegg.com/pngimages/178/595/png-clipart-user-profile-computer-icons-login-user-avatars-monochrome-black-thumbnail.png';
        }

        // Обновляем имя пользователя
        const profileName = document.querySelector('.wallet-profile-name');
        if (profileName) {
          // Try to get saved profile data first
          const savedProfile = localStorage.getItem(`user_profile_${user.uid}`);
          if (savedProfile) {
            try {
              const profileData = JSON.parse(savedProfile);
              const displayName = profileData.displayName || user.displayName || 'Anonymous';
              const handle = profileData.handle || 'anonymous';
              if (handle !== 'undefined') {
                profileName.innerHTML = `${displayName}<span class="wallet-profile-handle">@${handle}</span>`;
              } else {
                const randomId = Math.floor(Math.random() * 10000);
                profileName.innerHTML = `${displayName}<span class="wallet-profile-handle">@user_${randomId}</span>`;
              }
            } catch (e) {
              console.error('Error parsing saved profile data:', e);
              // Fallback to default logic
              const randomId = Math.floor(Math.random() * 10000);
              if (user.providerData && user.providerData[0]?.providerId === 'twitter.com') {
                const username = user.providerData[0].username || user.providerData[0].screenName;
                if (username && username !== 'undefined') {
                  profileName.innerHTML = `${user.displayName}<span class="wallet-profile-handle">@${username}</span>`;
                } else {
                  profileName.innerHTML = `${user.displayName}<span class="wallet-profile-handle">@user_${randomId}</span>`;
                }
              } else {
                profileName.innerHTML = `User<span class="wallet-profile-handle">@user_${randomId}</span>`;
              }
            }
          } else {
            // No saved profile, use default logic
            const randomId = Math.floor(Math.random() * 10000);
            if (user.providerData && user.providerData[0]?.providerId === 'twitter.com') {
              const username = user.providerData[0].username || user.providerData[0].screenName;
              if (username && username !== 'undefined') {
                profileName.innerHTML = `${user.displayName}<span class="wallet-profile-handle">@${username}</span>`;
              } else {
                profileName.innerHTML = `${user.displayName}<span class="wallet-profile-handle">@user_${randomId}</span>`;
              }
            } else {
              profileName.innerHTML = `User<span class="wallet-profile-handle">@user_${randomId}</span>`;
            }
          }
        }

        // Обновляем адрес кошелька
        renderWalletAddress();

        // Обновляем информацию о Twitter
        const twitterInfo = document.querySelector('.wallet-profile-twitter');
        if (twitterInfo) {
          if (user.providerData && user.providerData[0]?.providerId === 'twitter.com') {
            const screenName = user.providerData[0].username || user.providerData[0].screenName;
            if (screenName && screenName !== 'undefined') {
              twitterInfo.innerHTML = `<a href="https://twitter.com/${screenName}" style="color:#a020f0;">@${screenName}</a> <span style="color:#a020f0;">✔️</span>`;
              twitterInfo.style.display = '';
            } else {
              // Try to get saved profile data
              const savedProfile = localStorage.getItem(`user_profile_${user.uid}`);
              if (savedProfile) {
                try {
                  const profileData = JSON.parse(savedProfile);
                  if (profileData.handle && profileData.handle !== 'anonymous' && profileData.handle !== 'undefined' && !profileData.handle.startsWith('user_')) {
                    twitterInfo.innerHTML = `<a href="https://twitter.com/${profileData.handle}" style="color:#a020f0;">@${profileData.handle}</a> <span style="color:#a020f0;">✔️</span>`;
                    twitterInfo.style.display = '';
                  } else {
                    twitterInfo.style.display = 'none';
                  }
                } catch (e) {
                  console.error('Error parsing saved profile data:', e);
                  twitterInfo.style.display = 'none';
                }
              } else {
                twitterInfo.style.display = 'none';
              }
            }
          } else {
            twitterInfo.style.display = 'none';
          }
        }
      } else {
        document.querySelector('.container').style.display = '';
        document.getElementById('wallet').style.display = 'none';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('registerForm').style.display = '';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('showLoginForm').style.display = '';
        document.getElementById('showRegisterForm').style.display = 'none';
      }
    });

    // Edit Profile Logic
    const editProfileBtn = document.querySelector('.wallet-profile-btn.edit-profile-trigger');
    const editProfileModal = document.getElementById('editProfileModal');
    const closeEditProfile = document.getElementById('closeEditProfile');
    const editProfileAvatar = document.getElementById('editProfileAvatar');
    const editProfileAvatarInput = document.getElementById('editProfileAvatarInput');
    const editProfileName = document.getElementById('editProfileName');
    const editProfileUsername = document.getElementById('editProfileUsername');
    const editProfileBio = document.getElementById('editProfileBio');
    const saveProfile = document.getElementById('saveProfile');
    const emojiTrigger = document.getElementById('emojiTrigger');
    const connectBtn = document.getElementById('connectPhantomBtn');
    const walletAddressEl = document.getElementById('walletAddress');
    const copyBtn = document.querySelector('.wallet-copy-btn');
    const profileEmojiPanel = document.getElementById('emojiPanel');

    // Setup emoji panel
    if (profileEmojiPanel && editProfileBio && emojiTrigger) {
      const emojis = ['😊', '😂', '🤣', '❤️', '😍', '🙌', '👍', '👋', '🎉', '✨', '🔥', '💯', '🤔', '👀', '🎈', '🌟', '💪', '🙏', '👏', '🌈'];

      // Clear existing content
      profileEmojiPanel.innerHTML = '';

      emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.textContent = emoji;
        span.onclick = () => {
          const start = editProfileBio.selectionStart;
          const end = editProfileBio.selectionEnd;
          const text = editProfileBio.value;
          editProfileBio.value = text.substring(0, start) + emoji + text.substring(end);
          editProfileBio.focus();
          editProfileBio.selectionStart = editProfileBio.selectionEnd = start + emoji.length;
          profileEmojiPanel.style.display = 'none';
        };
        profileEmojiPanel.appendChild(span);
      });

      // Toggle emoji panel
      emojiTrigger.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        profileEmojiPanel.style.display = profileEmojiPanel.style.display === 'none' ? 'grid' : 'none';
      };

      // Close emoji panel when clicking outside
      document.addEventListener('click', (e) => {
        if (!profileEmojiPanel.contains(e.target) && e.target !== emojiTrigger) {
          profileEmojiPanel.style.display = 'none';
        }
      });
    }

    // Save profile handler
    if (saveProfile && editProfileModal) {
      saveProfile.onclick = async function (e) {
        e.preventDefault();
        const newName = editProfileName.value.trim();
        const newUsername = editProfileUsername.value.trim();
        let newAvatar = editProfileAvatar.src;
        if (!newName || !newUsername) {
          alert('Please fill in all required fields');
          return;
        }
        // Загрузка нового аватара через CDN-стиль
        if (editProfileAvatarInput.files && editProfileAvatarInput.files[0]) {
          const file = editProfileAvatarInput.files[0];
          const user = firebase.auth().currentUser;
          if (user) {
            try {
              const storage = firebase.storage();
              // Сохраняем в profile_images
              const storageRef = storage.ref(`profile_images/${user.uid}/${Date.now()}_${file.name}`);
              await storageRef.put(file);
              newAvatar = await storageRef.getDownloadURL();
            } catch (error) {
              alert('Error uploading avatar: ' + error.message);
              return;
            }
          }
        }
        // Дальнейшее обновление профиля
        const user = firebase.auth().currentUser;
        if (user) {
          try {
            await user.updateProfile({
              displayName: newName,
              photoURL: newAvatar
            });
            // ... остальной код обновления UI ...
          } catch (error) {
            alert('Error updating profile: ' + error.message);
          }
        }
        // После успешного user.updateProfile({ ... }) добавить:
        if (editProfileModal) {
          editProfileModal.style.display = 'none';
        }
        // После строки editProfileModal.style.display = 'none';
        window.location.reload();
      };
    }

    // Modal close handlers
    if (closeEditProfile && editProfileModal) {
      closeEditProfile.onclick = function (e) {
        e.preventDefault();
        editProfileModal.style.display = 'none';
      };

      // Close on outside click
      window.onclick = function (e) {
        if (e.target === editProfileModal) {
          editProfileModal.style.display = 'none';
        }
      };
    }

    // Avatar upload handling
    if (editProfileAvatarInput && editProfileAvatar) {
      editProfileAvatarInput.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            editProfileAvatar.src = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      };

      // Avatar overlay click handler
      const overlay = document.querySelector('.edit-profile-avatar-overlay');
      if (overlay) {
        overlay.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          editProfileAvatarInput.click();
        };
      }
    }

    function renderWalletAddress() {
      const walletAddressEl = document.getElementById('walletAddress');
      if (!walletAddressEl) return;

      const address = localStorage.getItem('wallet_address');
      
      if (!address) {
        // Wallet not connected - show Connect Wallet button
        walletAddressEl.innerHTML = `
          <button id="connectPhantomBtn" class="connect-wallet-btn">Connect Wallet</button>
        `;
        
        const connectBtn = document.getElementById('connectPhantomBtn');
        if (connectBtn) {
            connectBtn.addEventListener('click', async function () {
            try {
              if (!window.solana || !window.solana.isPhantom) {
                alert('Please install Phantom wallet');
                window.open('https://phantom.app/', '_blank');
                return;
              }

              console.log('Attempting to connect to Phantom...', window.solana);

              const resp = await window.solana.connect({ onlyIfTrusted: false });
              console.log('Phantom response:', resp);

              if (!resp || !resp.publicKey) {
                alert('Phantom did not return a publicKey. Did you cancel the connection?');
                return;
              }

              const address = resp.publicKey.toString();
              localStorage.setItem('wallet_address', address);
              renderWalletAddress(); // Re-render to show connected state
              
              // Fetch MESH balance after connecting wallet
              if (typeof fetchPostBalance === 'function') {
                fetchPostBalance();
              }
            } catch (err) {
              console.error('Error connecting to wallet:', err);
              alert('Error connecting to wallet: ' + (err?.message || JSON.stringify(err)));
            }
          });
        }
      } else {
        // Wallet connected - show address, Disconnect and Copy buttons
        walletAddressEl.innerHTML = `
          ${address.substring(0, 6)}...${address.substring(address.length - 4)}
          <button class="wallet-disconnect-btn" title="Disconnect wallet">Disconnect</button>
            <button class="wallet-copy-btn" data-address="Cm4qzi9sB9S6xgLje6kVq447aK4N5XM8DjgJXLJ963mU" title="Copy address"><img src="images/copy-icon.png" style="width:10px;height:10px;vertical-align:middle;"></button>
        `;
        
        // Disconnect button handler
        const disconnectBtn = walletAddressEl.querySelector('.wallet-disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', async function () {
            try {
              // Disconnect from Phantom wallet
              if (window.solana && window.solana.isPhantom) {
                await window.solana.disconnect();
              }

              // Clear stored address and any related localStorage if needed
              localStorage.removeItem('wallet_address');

              // Re-render the wallet address section
              renderWalletAddress();
              
              // Clear MESH balance display
              const balanceElements = document.querySelectorAll('.wallet-item-value');
              balanceElements.forEach(element => {
                element.textContent = '0.0000';
              });
            } catch (err) {
              console.error('Error disconnecting wallet:', err);
              alert('Error disconnecting wallet: ' + err.message);
            }
          });
        }
        
        // Copy button handler
        const copyBtn = walletAddressEl.querySelector('.wallet-copy-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function () {
            const addr = this.dataset.address;
            if (addr) {
              navigator.clipboard.writeText(addr)
                .then(() => {
                  this.title = 'Copied!';
                  setTimeout(() => { this.title = 'Copy address'; }, 1500);
                })
                .catch(() => alert('Copy failed. Please copy manually.'));
            }
          });
        }
      }
    }

    // Вызовем при загрузке страницы
    document.addEventListener('DOMContentLoaded', renderWalletAddress);

    // Function to fetch MESH token balance
    async function fetchPostBalance() {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          console.log('Phantom wallet not found');
          return;
        }

        // Use a more reliable RPC endpoint
        const connection = new solanaWeb3.Connection('https://solana-mainnet.rpc.extrnode.com');
        const walletAddress = localStorage.getItem('wallet_address');
        
        if (!walletAddress) {
          console.log('No wallet address found');
          return;
        }

        // MESH token mint address on Solana
        const postMintAddress = new solanaWeb3.PublicKey('C9U2Ksk6KKWvLEeo5yUQ7Xu46X7NzeBJtd9PBfuXaUSM');
        
        try {
          // Get token accounts for the wallet
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
            new solanaWeb3.PublicKey(walletAddress),
            { mint: postMintAddress }
          );

          let balance = 0;
          if (tokenAccounts.value.length > 0) {
            balance = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
          }

          // Update wallet-item-value elements
          const balanceElements = document.querySelectorAll('.wallet-item-value');
          balanceElements.forEach(element => {
            element.textContent = balance.toFixed(4);
          });

          // Update wallet-profile-balance elements
          const profileBalanceElements = document.querySelectorAll('.wallet-profile-balance');
          profileBalanceElements.forEach(element => {
            element.innerHTML = `<img src="images/logo2.png" style="width:14px;height:14px;vertical-align:middle;margin-right:2px;"> ${balance.toFixed(4)}`;
          });

          // Update wallet value after balance update
          updateWalletValue();
          window.postTokenBalance = balance;
          updateClubWalletBalance();
        } catch (error) {
          console.error('Error fetching token accounts:', error);
          // Set balance to 0 on error
          const balanceElements = document.querySelectorAll('.wallet-item-value, .wallet-profile-balance');
          balanceElements.forEach(element => {
            if (element.classList.contains('wallet-profile-balance')) {
              element.innerHTML = `<img src="images/logo2.png" style="width:14px;height:14px;vertical-align:middle;margin-right:2px;"> 0.0000`;
            } else {
              element.textContent = '0.0000';
            }
          });
          // Update wallet value with zero balance
          updateWalletValue();
        }
      } catch (error) {
        console.error('Error in fetchPostBalance:', error);
      }
    }

    // Function to fetch MESH price
    async function fetchPrice() {
      try {
        // Replace with actual API call to get MESH price
        const price = 0.04; // Example price
        const priceElements = document.querySelectorAll('.wallet-post-price');
        priceElements.forEach(element => {
          element.textContent = `$${price.toFixed(2)}`;
        });
        
        // Update wallet value after price update
        updateWalletValue();
      } catch (error) {
        console.error('Error fetching MESH price:', error);
      }
    }

    // Initial price and balance fetch
      document.addEventListener('DOMContentLoaded', function () {
      fetchPrice();
      fetchPostBalance();

      // Update price and balance every 10 seconds
      setInterval(() => {
        fetchPrice();
        fetchPostBalance();
      }, 10000);
    });

    // ... existing code ...

    // Update wallet connection handler to fetch balance
    if (connectBtn) {
        connectBtn.addEventListener('click', async function () {
        try {
          if (!window.solana || !window.solana.isPhantom) {
            alert('Please install Phantom wallet');
            window.open('https://phantom.app/', '_blank');
            return;
          }

          const resp = await window.solana.connect({ onlyIfTrusted: false });
          
          if (!resp || !resp.publicKey) {
            alert('Phantom did not return a publicKey. Did you cancel the connection?');
            return;
          }

          const address = resp.publicKey.toString();
          localStorage.setItem('wallet_address', address);
          renderWalletAddress();
          
          // Fetch MESH balance after connecting wallet
          await fetchPostBalance();

          // Set up periodic balance updates
          const balanceUpdateInterval = setInterval(fetchPostBalance, 10000); // Update every 10 seconds
          localStorage.setItem('balance_update_interval', balanceUpdateInterval);

        } catch (err) {
          console.error('Error connecting to wallet:', err);
          alert('Error connecting to wallet: ' + (err?.message || JSON.stringify(err)));
        }
      });
    }

    // Clear interval when disconnecting wallet
    const disconnectBtn = document.querySelector('.wallet-disconnect-btn');
    if (disconnectBtn) {
        disconnectBtn.addEventListener('click', function () {
        const intervalId = localStorage.getItem('balance_update_interval');
        if (intervalId) {
          clearInterval(parseInt(intervalId));
          localStorage.removeItem('balance_update_interval');
        }
      });
    }

    // Initial balance fetch if wallet is connected
      document.addEventListener('DOMContentLoaded', function () {
      const walletAddress = localStorage.getItem('wallet_address');
      if (walletAddress) {
        fetchPostBalance();
        // Set up periodic updates
        const balanceUpdateInterval = setInterval(fetchPostBalance, 10000);
        localStorage.setItem('balance_update_interval', balanceUpdateInterval);
      }
    });
    // ... existing code ...

    // Function to update wallet value
    function updateWalletValue() {
      try {
        const priceElements = document.querySelectorAll('.wallet-post-price');
        const balanceElements = document.querySelectorAll('.wallet-item-value');
        let totalValue = 0.0;
        if (priceElements.length > 0 && balanceElements.length > 0) {
          const price = parseFloat(priceElements[0].textContent.replace('$', ''));
          const balance = parseFloat(balanceElements[0].textContent);
          if (!isNaN(price) && !isNaN(balance)) {
            totalValue = price * balance;
          }
        }
        const valueElements = document.querySelectorAll('.wallet-value');
        valueElements.forEach(element => {
          element.textContent = isNaN(totalValue) ? '0.0' : totalValue.toFixed(1);
        });
      } catch (error) {
        const valueElements = document.querySelectorAll('.wallet-value');
        valueElements.forEach(element => {
          element.textContent = '0.0';
        });
        console.error('Error updating wallet value:', error);
      }
    }

    // Initial price and balance fetch
      document.addEventListener('DOMContentLoaded', function () {
      fetchPrice();
      fetchPostBalance();

      // Update price and balance every 10 seconds
      setInterval(() => {
        fetchPrice();
        fetchPostBalance();
      }, 10000);
    });

    // Function to fetch price from Pump.fun
    async function fetchPrice() {
      try {
        const response = await fetch('https://pump.fun/coin/Q3GoXRETCNMgj874FAuFkomvx18GmNGL7Ct2gWZpump');
        const html = await response.text();
        // Попробуем найти цену через регулярку (ищем $ и число)
        const match = html.match(/\$([0-9,.]+)/);
        let price = 0.00;
        if (match && match[1]) {
          price = parseFloat(match[1].replace(/,/g, ''));
        }
        const priceElements = document.querySelectorAll('.wallet-post-price');
        priceElements.forEach(element => {
          element.textContent = `$${price.toFixed(4)}`;
        });
        // Update wallet value after price update
        updateWalletValue();
      } catch (error) {
        console.error('Error fetching price:', error);
      }
    }

    // В JS добавить функцию для обновления clubWalletBalance:
    function updateClubWalletBalance() {
      const el = document.getElementById('clubWalletBalance');
      const createClubBtn = document.getElementById('createClubBtn');
      const clubConnectWalletBtn = document.getElementById('clubConnectWalletBtn');
      const address = localStorage.getItem('wallet_address');
      if (!el) return;
      if (!address) {
        el.textContent = 'Connect wallet first';
        el.style.color = '#e00';
        // Show connect wallet button
        if (clubConnectWalletBtn) {
          clubConnectWalletBtn.style.display = 'block';
        }
        // Disable the create club button
        if (createClubBtn) {
          createClubBtn.disabled = true;
          createClubBtn.style.opacity = '0.5';
          createClubBtn.style.cursor = 'not-allowed';
        }
        return;
      } else {
        // Keep connect wallet button visible but update create club button
        if (createClubBtn) {
          createClubBtn.disabled = false;
          createClubBtn.style.opacity = '1';
          createClubBtn.style.cursor = 'pointer';
        }
      }
      // Получаем баланс $MESH (например, из localStorage или глобальной переменной)
      let balance = 0;
      if (window.postTokenBalance !== undefined) {
        balance = window.postTokenBalance;
      } else {
        // Попробовать получить из DOM, если уже отображается
        const balEl = document.querySelector('.wallet-item-value');
        if (balEl) balance = parseFloat(balEl.textContent) || 0;
      }
      el.textContent = balance > 0 ? balance.toFixed(4) : '0.0000';
      el.style.color = '#a020f0';
      // Enable the button when wallet is connected
      if (createClubBtn) {
        createClubBtn.disabled = false;
        createClubBtn.style.opacity = '1';
        createClubBtn.style.cursor = 'pointer';
      }
    }
    // Add event listener for club connect wallet button
    const clubConnectWalletBtn = document.getElementById('clubConnectWalletBtn');
    if (clubConnectWalletBtn) {
        clubConnectWalletBtn.addEventListener('click', async function () {
        try {
          if (!window.solana || !window.solana.isPhantom) {
            alert('Please install Phantom wallet');
            window.open('https://phantom.app/', '_blank');
            return;
          }

          const resp = await window.solana.connect({ onlyIfTrusted: false });
          if (!resp || !resp.publicKey) {
            alert('Phantom did not return a publicKey. Did you cancel the connection?');
            return;
          }

          const address = resp.publicKey.toString();
          localStorage.setItem('wallet_address', address);
          updateClubWalletBalance();
          
          // Fetch MESH balance after connecting wallet
          if (typeof fetchPostBalance === 'function') {
            fetchPostBalance();
          }
        } catch (err) {
          console.error('Error connecting to wallet:', err);
          alert('Error connecting to wallet: ' + (err?.message || JSON.stringify(err)));
        }
      });
    }

    // Вызвать updateClubWalletBalance() при открытии модалки создания клуба и после подключения кошелька/обновления баланса.
  </script>
  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="close-button" id="closeEditProfile">&times;</button>
      </div>
      <div class="edit-profile-form">
        <div class="edit-profile-avatar-container">
          <img id="editProfileAvatar" src="" alt="Profile Avatar">
          <div class="edit-profile-avatar-overlay">
            <input type="file" id="editProfileAvatarInput" accept="image/*" style="display: none;">
            <label for="editProfileAvatarInput">
              <img src="https://www.svgrepo.com/show/495939/camera.svg" class="edit-profile-camera-icon">
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="editProfileName">Name</label>
          <input type="text" id="editProfileName" placeholder="Enter your name">
        </div>
        <div class="form-group">
          <label for="editProfileUsername">Username</label>
          <input type="text" id="editProfileUsername" placeholder="Enter your username">
        </div>
        <button id="saveProfile" class="save-profile-btn">Save Changes</button>
      </div>
    </div>
  </div>
  <script>
      document.addEventListener('DOMContentLoaded', function () {
      // Get DOM elements
      const editProfileBtn = document.querySelector('.edit-profile-trigger');
      const editProfileModal = document.getElementById('editProfileModal');
      const closeEditProfile = document.getElementById('closeEditProfile');
      const editProfileAvatar = document.getElementById('editProfileAvatar');
      const editProfileAvatarInput = document.getElementById('editProfileAvatarInput');
      const editProfileName = document.getElementById('editProfileName');
      const editProfileUsername = document.getElementById('editProfileUsername');
      const saveProfile = document.getElementById('saveProfile');

      // Load current profile data
      const currentUser = firebase.auth().currentUser;
      const profileAvatar = document.querySelector('.wallet-profile-avatar');
      const profileName = document.querySelector('.wallet-profile-name');

      // Open modal
        editProfileBtn.addEventListener('click', function () {
        // Set current values
        editProfileAvatar.src = profileAvatar.src;
        editProfileName.value = profileName.textContent.split('@')[0].trim();
        editProfileUsername.value = profileName.querySelector('.wallet-profile-handle').textContent.replace('@', '');
        
        editProfileModal.style.display = 'block';
      });

      // Close modal
        closeEditProfile.addEventListener('click', function () {
        editProfileModal.style.display = 'none';
      });

      // Close modal when clicking outside
        window.addEventListener('click', function (event) {
        if (event.target === editProfileModal) {
          editProfileModal.style.display = 'none';
        }
      });

      // Handle avatar upload
        editProfileAvatarInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
            reader.onload = function (e) {
            editProfileAvatar.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Save profile changes
        saveProfile.addEventListener('click', async function () {
        const newName = editProfileName.value.trim();
        const newUsername = editProfileUsername.value.trim();
        let newAvatar = editProfileAvatar.src;

        if (!newName || !newUsername) {
          alert('Please fill in all required fields');
          return;
        }

        // Если выбрана новая картинка, загружаем её в Firebase Storage
        if (editProfileAvatarInput.files && editProfileAvatarInput.files[0]) {
          const file = editProfileAvatarInput.files[0];
          const user = firebase.auth().currentUser;
          if (user) {
            try {
              const storage = firebase.storage();
              // Сохраняем в profile_images
              const storageRef = storage.ref(`profile_images/${user.uid}/${Date.now()}_${file.name}`);
              await storageRef.put(file);
              newAvatar = await storageRef.getDownloadURL();
            } catch (error) {
              alert('Error uploading avatar: ' + error.message);
              return;
            }
          }
        }

        // Update profile in Firebase
        const user = firebase.auth().currentUser;
        if (user) {
          try {
            await user.updateProfile({
              displayName: newName,
              photoURL: newAvatar
            });
            // ... остальной код обновления UI ...
          } catch (error) {
            alert('Error updating profile: ' + error.message);
          }
        }
        // После успешного user.updateProfile({ ... }) добавить:
        if (editProfileModal) {
          editProfileModal.style.display = 'none';
          window.location.reload();
        }
        // После строки editProfileModal.style.display = 'none';
        
      });
    });
  </script>
  <script>
      document.addEventListener('DOMContentLoaded', function () {
      // ... existing code ...
      function setMeshPrice(value) {
  const priceElements = document.querySelectorAll('.wallet-post-price');
  let price = parseFloat(value);
  priceElements.forEach(element => {
    element.textContent = isNaN(price) ? '0.0' : price.toFixed(4);
  });
}
      // Function to fetch price from GeckoTerminal
      async function fetchPrice() {
        try {
          const response = await fetch('https://api.geckoterminal.com/api/v2/networks/solana/pools/Q3GoXRETCNMgj874FAuFkomvx18GmNGL7Ct2gWZpump');
          const data = await response.json();
          
          if (data && data.data && data.data.attributes) {
            const price = data.data.attributes.price_usd;
setMeshPrice(price);
            
            // Update wallet value after price update
            updateWalletValue();
          }
        } catch (error) {
          console.error('Error fetching price:', error);
        }
      }

      // Initial price fetch
      fetchPrice();

      // Update price every 10 seconds
      setInterval(fetchPrice, 10000);

      // Function to fetch MESH token balance
      async function fetchPostBalance() {
        try {
          const address = localStorage.getItem('wallet_address');
          if (!address) return;

          // Fetch token balance from Solana RPC
          const response = await fetch('https://api.mainnet-beta.solana.com', {
            method: 'MESH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              jsonrpc: '2.0',
              id: 1,
              method: 'getTokenAccountsByOwner',
              params: [
                address,
                {
                  mint: 'Q3GoXRETCNMgj874FAuFkomvx18GmNGL7Ct2gWZpump' // Replace with actual MESH token mint address
                },
                {
                  encoding: 'jsonParsed'
                }
              ]
            })
          });

          const data = await response.json();
          if (data.result && data.result.value && data.result.value[0]) {
            const balance = data.result.value[0].account.data.parsed.info.tokenAmount.uiAmount;
            const balanceElements = document.querySelectorAll('.wallet-item-value');
            balanceElements.forEach(element => {
              element.textContent = balance.toFixed(4);
            });
          }
        } catch (error) {
          console.error('Error fetching MESH balance:', error);
        }
      }

      // Initial price and balance fetch
      fetchPrice();
      fetchPostBalance();

      // Update price and balance every 10 seconds
      setInterval(() => {
        fetchPrice();
        fetchPostBalance();
      }, 10000);
    });
    // ... existing code ...
  </script>
  <!-- Add Solana Web3 library -->
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
  <script>
    // ... existing code ...

    document.addEventListener('DOMContentLoaded', function () {
  const syncTwitterBtn = document.querySelector('.sync-twitter-btn');

  if (syncTwitterBtn) {
    syncTwitterBtn.addEventListener('click', async function () {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please log in first');
          return;
        }

        const idToken = await user.getIdToken(true);
        const res = await fetch('https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=AIzaSyCuL4tpaSsw1ylXf2VZrQ1b_2t_Kxd97cI', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });

        const data = await res.json();
        const userData = data.users?.[0];
        const twitter = userData?.providerUserInfo?.find(p => p.providerId === 'twitter.com');

        if (!twitter) {
          alert('Twitter account not linked.');
          return;
        }

        const displayName = twitter.displayName || 'Anonymous';
        const photoURL = twitter.photoUrl || '';
        const screenName = twitter.screenName || userData.providerUserInfo.find(p => p.providerId === 'twitter.com').screenName;

        // Обновляем аватар
        const profileAvatar = document.querySelector('.wallet-profile-avatar');
        if (profileAvatar && photoURL) {
          profileAvatar.src = photoURL;
        }

        // Обновляем имя и handle
        const profileName = document.querySelector('.wallet-profile-name');
        if (profileName) {
          profileName.innerHTML = `${displayName}<span class="wallet-profile-handle">@${screenName}</span>`;
        }

        // Обновляем Twitter ссылку
        const twitterLink = document.querySelector('.wallet-profile-twitter');
        if (twitterLink) {
          twitterLink.innerHTML = `<a href="https://twitter.com/${twitter.screenName}" style="color:#a020f0;">@${twitter.screenName}</a> <span style="color:#a020f0;">✔️</span>`;
          twitterLink.style.display = '';
        }

        // Обновляем все .wallet-profile-handle
        document.querySelectorAll('.wallet-profile-handle').forEach(el => {
          el.textContent = `@${screenName}`;
        });

        alert('Twitter profile synced successfully!');
      } catch (err) {
        console.error('Twitter sync error:', err);
        alert('Failed to sync Twitter: ' + err.message);
      }
    });
  }
});


    // ... existing code ...
  </script>
  <script>
      document.addEventListener('DOMContentLoaded', function () {
      // ... существующий код ...
      const unlinkTwitterBtn = document.querySelector('.wallet-profile-btn:not(.edit-profile-trigger):not(.sync-twitter-btn)');
      if (unlinkTwitterBtn) {
          unlinkTwitterBtn.addEventListener('click', async function () {
          const user = firebase.auth().currentUser;
          if (!user) {
            alert('Please log in first');
            return;
          }
          try {
            await user.unlink('twitter.com');
            alert('Twitter account unlinked!');
            // Скрыть Twitter-инфо
            const twitterInfo = document.querySelector('.wallet-profile-twitter');
            if (twitterInfo) twitterInfo.style.display = 'none';
            // Скрыть кнопку Sync Twitter
            const syncTwitterBtn = document.querySelector('.sync-twitter-btn');
            if (syncTwitterBtn) syncTwitterBtn.style.display = 'none';
            // Заменить Unlink Twitter на Link Twitter
            unlinkTwitterBtn.textContent = 'Link Twitter';
            unlinkTwitterBtn.classList.add('link-twitter-btn');
            // Назначить обработчик для Link Twitter
              unlinkTwitterBtn.onclick = async function () {
              const provider = new firebase.auth.TwitterAuthProvider();
              try {
                await user.linkWithPopup(provider);
                alert('Twitter account linked!');
                // Можно обновить UI, например, показать Sync Twitter и Twitter-инфо
                if (syncTwitterBtn) syncTwitterBtn.style.display = '';
                if (twitterInfo) twitterInfo.style.display = '';
                unlinkTwitterBtn.textContent = 'Unlink Twitter';
                unlinkTwitterBtn.classList.remove('link-twitter-btn');
                // Вернуть исходный обработчик
                window.location.reload(); // проще всего перезагрузить для корректного UI
              } catch (error) {
                alert('Error linking Twitter: ' + error.message);
              }
            };
          } catch (error) {
            alert('Error unlinking Twitter: ' + error.message);
          }
        });
      }
    });

</script>
<script type="module">
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
  const storage = getStorage();

  async function uploadAvatar(file, userId) {
    try {
      const storageRef = ref(storage, `avatars/${userId}/${Date.now()}_${file.name}`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);
      return downloadURL;
    } catch (error) {
      console.error("Error uploading avatar:", error);
      throw error;
    }
  }

      document.addEventListener('DOMContentLoaded', function () {
    // ... существующий код ...
    const editProfileAvatarInput = document.getElementById('editProfileAvatarInput');
    const editProfileAvatar = document.getElementById('editProfileAvatar');
    const saveProfile = document.getElementById('saveProfile');
    const editProfileName = document.getElementById('editProfileName');
    const editProfileUsername = document.getElementById('editProfileUsername');

        saveProfile.addEventListener('click', async function () {
      const newName = editProfileName.value.trim();
      const newUsername = editProfileUsername.value.trim();
      let newAvatar = editProfileAvatar.src;
      if (!newName || !newUsername) {
        alert('Please fill in all required fields');
        return;
      }
      if (editProfileAvatarInput.files && editProfileAvatarInput.files[0]) {
        const file = editProfileAvatarInput.files[0];
        const user = firebase.auth().currentUser;
        if (user) {
          try {
            newAvatar = await uploadAvatar(file, user.uid);
          } catch (error) {
            alert('Error uploading avatar: ' + error.message);
            return;
          }
        }
      }
      // ... остальной код сохранения профиля ...
      // Например, user.updateProfile({ displayName: newName, photoURL: newAvatar })
    });
  });
</script>
<!-- ✅ Скрипты для управления балансом и синхронизации Discover -->
<script>
  // Обновление баланса и Discover
  function updateClubBalance(clubId, delta) {
    const chat = document.querySelector(`.fschat[data-club="${clubId}"]`);
    const discover = document.querySelector(`.discover-item[data-club="${clubId}"]`);

    if (!chat || !discover) return;

    const balanceEl = chat.querySelector('.fschat-balance');
    const priceEl = discover.querySelector('.discover-price');

    if (!balanceEl || !priceEl) return;

    let balance = parseFloat(balanceEl.textContent) || 0;
    balance += delta;

    balanceEl.textContent = balance.toFixed(1) + ' $MESH';
    priceEl.textContent = `Price: ${balance.toFixed(1)} $MESH`;

    localStorage.setItem('chat_balance_' + clubId, balance.toFixed(1));
  }

  // Инициализация балансов при загрузке
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.fschat[data-club]').forEach(chat => {
      const clubId = chat.getAttribute('data-club');
      const balanceEl = chat.querySelector('.fschat-balance');
      const savedBalance = parseFloat(localStorage.getItem('chat_balance_' + clubId)) || 0;
      if (balanceEl) {
        balanceEl.textContent = savedBalance.toFixed(1) + ' $MESH';
      }
    });

    document.querySelectorAll('.discover-item[data-club]').forEach(item => {
      const clubId = item.getAttribute('data-club');
const discoverItem = document.querySelector(`.discover-item[data-club="${clubId}"]`);
if (discoverItem) {
  const priceEl = discoverItem.querySelector('.discover-price');
  const savedBalance = parseFloat(localStorage.getItem('chat_balance_' + clubId)) || 0;
  if (priceEl) {
    priceEl.textContent = `Price: ${savedBalance.toFixed(1)} $MESH`;
    console.log('✅ Updated discover-price:', priceEl.textContent);
  }
}

    });
  });
</script>

<!-- ✅ Скрытие сайдбара при выборе пункта на мобильной версии -->
<script>
  const sidebar = document.getElementById('sidebar');
  const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
  const sidebarDim = document.getElementById('sidebarDim');

  function updateSidebarVisibility() {
    if (window.innerWidth <= 768) {
      mobileMenuBtn.style.display = 'flex';
      sidebar.classList.remove('mobile-open');
      sidebarDim.classList.remove('active');
      mobileMenuBtn.classList.remove('open');
    } else {
      mobileMenuBtn.style.display = 'none';
      sidebar.classList.remove('mobile-open');
      sidebarDim.classList.remove('active');
      mobileMenuBtn.classList.remove('open');
    }
  }

  mobileMenuBtn.onclick = function () {
    sidebar.classList.toggle('mobile-open');
    sidebarDim.classList.toggle('active');
    this.classList.toggle('open');
  };

  sidebarDim.onclick = function () {
    sidebar.classList.remove('mobile-open');
    sidebarDim.classList.remove('active');
    mobileMenuBtn.classList.remove('open');
  };

  sidebar.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('click', function (e) {
      if (this.tagName === 'A') return;
      
      // Close mobile menu when switching sections
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-open');
        sidebarDim.classList.remove('active');
        mobileMenuBtn.classList.remove('open');
      }
      
      // Update active state
      sidebar.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      
      // Show corresponding tab content
      const tabId = this.getAttribute('data-tab');
      document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
      document.getElementById('tab-' + tabId).style.display = 'block';

      // Close sidebar when any tab becomes active
      sidebar.classList.remove('active');
      mobileMenuBtn.classList.remove('active');
    });
  });
// ... existing code ...
</script>

<!-- ✅ Chat Notification Toggle -->
<script>
  (function () {
  const notifyBtn = document.getElementById('notificationToggleBtn');

  function updateNotificationButtonState() {
    const isEnabled = localStorage.getItem('notifications_enabled') === 'true';
    notifyBtn.textContent = isEnabled ? 'Turn off' : 'Turn on';
  }

  async function handleNotificationPermission() {
    if (!('Notification' in window)) {
      alert('This browser does not support notifications');
      return;
    }

    try {
      const permission = await Notification.requestPermission();

      if (permission === 'granted') {
        localStorage.setItem('notifications_enabled', 'true');
        updateNotificationButtonState();

        new Notification('Notifications Enabled', {
          body: 'You will now receive notifications from MESH',
          icon: 'images/logo2.png'
        });
      } else {
        localStorage.removeItem('notifications_enabled');
        updateNotificationButtonState();
      }
    } catch (error) {
      console.error('Error requesting notification permission:', error);
      alert('Error enabling notifications. Please try again.');
    }
  }

  notifyBtn.addEventListener('click', function () {
    if (this.textContent === 'Turn on') {
      handleNotificationPermission();
    } else {
      localStorage.removeItem('notifications_enabled');
      updateNotificationButtonState();
    }
  });

  document.addEventListener('DOMContentLoaded', updateNotificationButtonState);
})();

</script>

<!-- ✅ Notification Popup System -->
<script>
      (function () {
    const bellIcon = document.querySelector('.chat-bell');
    const notificationPopup = document.querySelector('.notification-popup');
    let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');

    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      bellIcon.classList.toggle('has-notifications', unreadCount > 0);
    }

    function renderNotifications() {
      const notificationList = document.querySelector('.notification-list');
      if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
        return;
      }

      notificationList.innerHTML = notifications.map((notification, index) => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" data-index="${index}">
          <div style="font-weight: ${notification.read ? 'normal' : '600'}">${notification.message}</div>
          <div style="font-size: 0.85rem; color: #888; margin-top: 4px;">${notification.time}</div>
        </div>
      `).join('');

      document.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', function () {
          const index = parseInt(this.dataset.index);
          notifications[index].read = true;
          localStorage.setItem('notifications', JSON.stringify(notifications));
          updateNotificationBadge();
          renderNotifications();
        });
      });
    }

        bellIcon.addEventListener('click', function (e) {
      e.stopPropagation();
      notificationPopup.classList.toggle('active');
      if (notificationPopup.classList.contains('active')) {
        renderNotifications();
      }
    });

        document.addEventListener('click', function (e) {
      if (!notificationPopup.contains(e.target) && e.target !== bellIcon) {
        notificationPopup.classList.remove('active');
      }
    });

    updateNotificationBadge();
  })();
</script>

<script>
// ... existing code ...
    // Update Twitter buttons based on auth method
    function updateTwitterButtons() {
      const user = firebase.auth().currentUser;
      const twitterButtonsContainer = document.getElementById('twitterButtons');
      
      if (!user) return;
      
      // Check if user has Twitter provider
      const hasTwitterProvider = user.providerData.some(provider => provider.providerId === 'twitter.com');
      
      if (hasTwitterProvider) {
        // User has Twitter connected
        twitterButtonsContainer.innerHTML = `
          <button class="wallet-profile-btn sync-twitter-btn">Sync Twitter</button>
          <button class="wallet-profile-btn unlink-twitter-btn">Unlink Twitter</button>
        `;
        
        // Add event listeners for the new buttons
        const syncBtn = twitterButtonsContainer.querySelector('.sync-twitter-btn');
        const unlinkBtn = twitterButtonsContainer.querySelector('.unlink-twitter-btn');
        
        if (syncBtn) {
          syncBtn.addEventListener('click', async function() {
            try {
              console.log('Starting Twitter sync process...');
              
              // Reload user data to get fresh Twitter info
              await user.reload();
              const updatedUser = firebase.auth().currentUser;
              
              if (!updatedUser) {
                throw new Error('No user found after reload');
              }
              
              // Get Twitter provider data
              const twitterProvider = updatedUser.providerData.find(provider => provider.providerId === 'twitter.com');
              
              if (!twitterProvider) {
                throw new Error('Twitter provider data not found');
              }
              
              console.log('Twitter provider data:', twitterProvider);
              
              // Log all available properties to debug
              console.log('Available Twitter provider properties:', Object.keys(twitterProvider));
              console.log('screenName:', twitterProvider.screenName);
              console.log('username:', twitterProvider.username);
              console.log('rawId:', twitterProvider.rawId);
              console.log('uid:', twitterProvider.uid);
              console.log('displayName:', twitterProvider.displayName);
              
              // Extract Twitter data with fallbacks
              const displayName = twitterProvider.displayName || 'Anonymous';
              const photoURL = twitterProvider.photoURL || '';
              
              // Try multiple ways to get the handle/username
              let handle = '';
              if (twitterProvider.screenName) {
                handle = twitterProvider.screenName;
                console.log('Using screenName for handle:', handle);
              } else if (twitterProvider.username) {
                handle = twitterProvider.username;
                console.log('Using username for handle:', handle);
              } else if (twitterProvider.uid && twitterProvider.uid !== twitterProvider.displayName) {
                // Twitter API no longer provides screenName through Firebase Auth
                // Use verification system to prompt and verify handle
                console.log('Twitter screenName not available through Firebase Auth');
                
                const userHandle = await promptAndVerifyTwitterHandle(twitterProvider);
                
                if (userHandle) {
                  handle = userHandle;
                  console.log('Using verified user-provided handle:', handle);
                } else {
                  // Only use fallback if user explicitly cancelled (returned null)
                  // Don't use fallback if verification failed but user wants to keep trying
                  console.log('User cancelled handle input, using fallback');
                  handle = `user_${twitterProvider.uid.slice(-6)}`;
                  console.log('Using UID-based fallback handle:', handle);
                }
              } else if (twitterProvider.rawId) {
                handle = twitterProvider.rawId;
                console.log('Using rawId for handle:', handle);
              } else if (twitterProvider.displayName) {
                handle = twitterProvider.displayName.toLowerCase().replace(/\s+/g, '_');
                console.log('Using displayName for handle (fallback):', handle);
              } else {
                handle = 'anonymous';
                console.log('Using anonymous for handle (last fallback)');
              }
              
              console.log('Extracted data:', { displayName, photoURL, handle });
              
              // Update profile avatar
              const profileAvatar = document.querySelector('.wallet-profile-avatar');
              if (profileAvatar && photoURL) {
                profileAvatar.src = photoURL;
              }
              
              // Update profile name and handle
              const profileName = document.querySelector('.wallet-profile-name');
              if (profileName) {
                profileName.innerHTML = `${displayName}<span class="wallet-profile-handle">@${handle}</span>`;
              }
              
              // Update Twitter info
              const twitterInfo = document.querySelector('.wallet-profile-twitter');
              if (twitterInfo) {
                twitterInfo.innerHTML = `<a href="https://twitter.com/${handle}" style="color:#a020f0;">@${handle}</a> <span style="color:#a020f0;">✔️</span>`;
                twitterInfo.style.display = '';
              }
              
              // Update all wallet-profile-handle elements
              document.querySelectorAll('.wallet-profile-handle').forEach(el => {
                el.textContent = `@${handle}`;
              });
              
              // Save profile data to localStorage
              const profileData = {
                displayName,
                photoURL,
                handle,
                lastSync: new Date().toISOString()
              };
              localStorage.setItem(`user_profile_${user.uid}`, JSON.stringify(profileData));
              console.log('Profile data saved to localStorage:', profileData);
              
              // Also save as currentUser for chat compatibility
              const currentUserData = {
                uid: user.uid,
                name: displayName,
                handle: handle,
                photoURL: photoURL
              };
              localStorage.setItem('currentUser', JSON.stringify(currentUserData));
              console.log('Current user data saved for chat:', currentUserData);
              
              // Verify the data was saved correctly
              const verifyData = localStorage.getItem(`user_profile_${user.uid}`);
              console.log('Verification - data in localStorage:', verifyData);
              if (verifyData) {
                try {
                  const parsedVerify = JSON.parse(verifyData);
                  console.log('Verification - parsed data:', parsedVerify);
                } catch (e) {
                  console.error('Verification failed - could not parse saved data:', e);
                }
              }
              
              // Update user profile in Firebase
              await updatedUser.updateProfile({
                displayName,
                photoURL
              });
              
              // Immediately update the UI with new data
              updateProfileUI(profileData);
              
              // Dispatch event for chat windows to update user data
              window.dispatchEvent(new CustomEvent('userDataUpdated', { detail: profileData }));
              
              alert('Twitter profile synced successfully!');
            } catch (error) {
              console.error('Error syncing Twitter profile:', error);
              alert('Error syncing Twitter profile: ' + error.message);
            }
          });
        }
        
        if (unlinkBtn) {
          unlinkBtn.addEventListener('click', async function() {
            try {
              await user.unlink('twitter.com');
              
              // Clear Twitter-related data
              localStorage.removeItem(`user_profile_${user.uid}`);
              console.log('Profile data cleared from localStorage');
              
              // Update UI
              const twitterInfo = document.querySelector('.wallet-profile-twitter');
              if (twitterInfo) twitterInfo.style.display = 'none';
              
              // Reset profile to default
              const profileName = document.querySelector('.wallet-profile-name');
              if (profileName) {
                const randomId = Math.floor(Math.random() * 10000);
                profileName.innerHTML = `User<span class="wallet-profile-handle">@user_${randomId}</span>`;
              }
              
              const profileAvatar = document.querySelector('.wallet-profile-avatar');
              if (profileAvatar) {
                profileAvatar.src = 'https://e7.pngegg.com/pngimages/178/595/png-clipart-user-profile-computer-icons-login-user-avatars-monochrome-black-thumbnail.png';
              }
              
              // Update user profile in Firebase to clear Twitter data
              await user.updateProfile({
                displayName: 'User',
                photoURL: 'https://e7.pngegg.com/pngimages/178/595/png-clipart-user-profile-computer-icons-login-user-avatars-monochrome-black-thumbnail.png'
              });
              
              // Update buttons
              updateTwitterButtons();
              
              alert('Twitter account unlinked successfully!');
            } catch (error) {
              console.error('Error unlinking Twitter:', error);
              alert('Error unlinking Twitter: ' + error.message);
            }
          });
        }
      } else {
        // User doesn't have Twitter connected
        twitterButtonsContainer.innerHTML = `
          <button class="wallet-profile-btn connect-twitter-btn">Connect Twitter</button>
        `;
        
        const connectBtn = twitterButtonsContainer.querySelector('.connect-twitter-btn');
        if (connectBtn) {
          connectBtn.addEventListener('click', async function() {
            const provider = new firebase.auth.TwitterAuthProvider();
            try {
              const result = await user.linkWithPopup(provider);
              const twitterProvider = result.user.providerData.find(provider => provider.providerId === 'twitter.com');
              
              if (twitterProvider) {
                console.log('Connected Twitter provider data:', twitterProvider);
                
                // Extract Twitter data with fallbacks
                const displayName = twitterProvider.displayName || 'Anonymous';
                const photoURL = twitterProvider.photoURL || '';
                
                // Try multiple ways to get the handle/username
                let handle = '';
                if (twitterProvider.screenName) {
                  handle = twitterProvider.screenName;
                } else if (twitterProvider.username) {
                  handle = twitterProvider.username;
                } else if (twitterProvider.rawId) {
                  handle = twitterProvider.rawId;
                } else if (twitterProvider.displayName) {
                  handle = twitterProvider.displayName.toLowerCase().replace(/\s+/g, '_');
                } else {
                  handle = 'anonymous';
                }
                
                // Save profile data
                const profileData = {
                  displayName,
                  photoURL,
                  handle,
                  lastSync: new Date().toISOString()
                };
                localStorage.setItem(`user_profile_${user.uid}`, JSON.stringify(profileData));
                console.log('Profile data saved after Twitter connection:', profileData);
                
                // Update user profile
                await user.updateProfile({
                  displayName,
                  photoURL
                });
              }
              
              alert('Twitter account connected!');
              updateTwitterButtons();
              window.location.reload();
            } catch (error) {
              console.error('Error connecting Twitter:', error);
              alert('Error connecting Twitter: ' + error.message);
            }
          });
        }
      }
    }

    // Call updateTwitterButtons when auth state changes
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        updateTwitterButtons();
      }
    });
// ... existing code ...

    // Function to update profile UI immediately
    function updateProfileUI(profileData) {
      console.log('Updating profile UI with data:', profileData);
      
      // Update avatar
      const profileAvatar = document.querySelector('.wallet-profile-avatar');
      if (profileAvatar && profileData.photoURL) {
        profileAvatar.src = profileData.photoURL;
      }
      
      // Update name and handle
      const profileName = document.querySelector('.wallet-profile-name');
      if (profileName) {
        const displayName = profileData.displayName || 'Anonymous';
        const handle = profileData.handle || 'anonymous';
        profileName.innerHTML = `${displayName}<span class="wallet-profile-handle">@${handle}</span>`;
      }
      
      // Update Twitter info - fix undefined issue
      const twitterInfo = document.querySelector('.wallet-profile-twitter');
      if (twitterInfo) {
        const handle = profileData.handle;
        if (handle && handle !== 'anonymous' && handle !== 'undefined' && !handle.startsWith('user_')) {
          // Show Twitter link only for real Twitter handles
          twitterInfo.innerHTML = `<a href="https://twitter.com/${handle}" style="color:#a020f0;">@${handle}</a> <span style="color:#a020f0;">✔️</span>`;
          twitterInfo.style.display = '';
        } else {
          // Hide Twitter info for non-Twitter handles
          twitterInfo.style.display = 'none';
        }
      }
      
      // Update all wallet-profile-handle elements
      document.querySelectorAll('.wallet-profile-handle').forEach(el => {
        const handle = profileData.handle || 'anonymous';
        if (handle !== 'undefined') {
          el.textContent = `@${handle}`;
        }
      });
      
      console.log('Profile UI updated successfully');
    }

    // Update Twitter buttons based on auth method

    // Function to verify Twitter handle matches the user's account
    async function verifyTwitterHandle(handle, expectedDisplayName, expectedPhotoURL) {
      try {
        console.log('Verifying Twitter handle:', handle);
        console.log('Expected display name:', expectedDisplayName);
        
        // Method 1: Try to fetch user data from Twitter's public page
        try {
          const proxyUrl = 'https://api.allorigins.win/raw?url=';
          const twitterUrl = `https://twitter.com/${handle}`;
          
          const response = await fetch(proxyUrl + encodeURIComponent(twitterUrl));
          const html = await response.text();
          
          // Extract display name from Twitter page HTML
          const displayNameMatch = html.match(/<title>([^(]+)\s*\(/);
          const extractedName = displayNameMatch ? displayNameMatch[1].trim() : null;
          
          console.log('Method 1 - Extracted name from Twitter page:', extractedName);
          
          // Check if the extracted name matches the expected display name
          if (extractedName && extractedName.toLowerCase() === expectedDisplayName.toLowerCase()) {
            console.log('✅ Twitter handle verification successful (Method 1)');
            return true;
          }
        } catch (error) {
          console.log('Method 1 failed, trying alternative method:', error.message);
        }
        
        // Method 2: Try alternative verification using different proxy
        try {
          const altProxyUrl = 'https://cors-anywhere.herokuapp.com/';
          const twitterUrl = `https://twitter.com/${handle}`;
          
          const response = await fetch(altProxyUrl + twitterUrl);
          const html = await response.text();
          
          // Look for the display name in meta tags or JSON-LD
          const metaNameMatch = html.match(/<meta property="og:title" content="([^"]+)"/);
          const extractedName = metaNameMatch ? metaNameMatch[1].trim() : null;
          
          console.log('Method 2 - Extracted name from meta tags:', extractedName);
          
          if (extractedName && extractedName.toLowerCase() === expectedDisplayName.toLowerCase()) {
            console.log('✅ Twitter handle verification successful (Method 2)');
            return true;
          }
        } catch (error) {
          console.log('Method 2 also failed:', error.message);
        }
        
        // Method 3: Basic format validation and user confirmation
        console.log('❌ Automatic verification failed, falling back to user confirmation');
        return 'manual_confirm';
        
      } catch (error) {
        console.error('Error verifying Twitter handle:', error);
        return 'error';
      }
    }

    // Function to prompt user for handle and verify it
    async function promptAndVerifyTwitterHandle(twitterProvider) {
      const maxAttempts = 3;
      let attempts = 0;
      
      while (attempts < maxAttempts) {
        attempts++;
        
        const userHandle = prompt(`Twitter handle not automatically detected.\nPlease enter your Twitter handle (without @):\n\nExample: if your Twitter is @john_doe, enter: john_doe\n\nAttempt ${attempts}/${maxAttempts}`);
        
        if (!userHandle || !userHandle.trim()) {
          // User cancelled or entered empty string
          return null;
        }
        
        const cleanHandle = userHandle.trim().replace('@', '');
        
        // Basic validation
        if (!/^[a-zA-Z0-9_]{1,15}$/.test(cleanHandle)) {
          alert('Invalid Twitter handle format. Please use only letters, numbers, and underscores (max 15 characters).');
          continue;
        }
        
        // Show loading message
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10000;';
        loadingMsg.textContent = 'Verifying Twitter handle...';
        document.body.appendChild(loadingMsg);
        
        try {
          // Verify the handle
          const verificationResult = await verifyTwitterHandle(cleanHandle, twitterProvider.displayName, twitterProvider.photoURL);
          
          document.body.removeChild(loadingMsg);
          
          if (verificationResult === true) {
            alert('✅ Twitter handle verified successfully!');
            return cleanHandle;
          } else if (verificationResult === 'manual_confirm') {
            const manualConfirm = confirm(`⚠️ Could not automatically verify Twitter handle "@${cleanHandle}".\n\nExpected account name: ${twitterProvider.displayName}\n\nAre you sure this is your correct Twitter handle?\n\nClick OK to confirm, or Cancel to try again.`);
            if (manualConfirm) {
              alert('✅ Twitter handle confirmed manually!');
              return cleanHandle;
            }
          } else if (verificationResult === 'error') {
            const continueAnyway = confirm('⚠️ Could not verify Twitter handle due to technical issues.\n\nDo you want to continue anyway?\n\nNote: Make sure you entered your correct Twitter handle.');
            if (continueAnyway) {
              return cleanHandle;
            }
          } else {
            alert(`❌ Twitter handle verification failed.\n\nThe handle "@${cleanHandle}" does not appear to belong to your Twitter account.\n\nExpected name: ${twitterProvider.displayName}\n\nPlease enter your correct Twitter handle.`);
          }
        } catch (error) {
          document.body.removeChild(loadingMsg);
          console.error('Verification error:', error);
          
          const continueAnyway = confirm('⚠️ Error during verification.\n\nDo you want to continue anyway?\n\nNote: Make sure you entered your correct Twitter handle.');
          if (continueAnyway) {
            return cleanHandle;
          }
        }
      }
      
      // Max attempts reached
      alert('Maximum verification attempts reached. Using fallback handle.');
      return null;
    }

    // Update Twitter buttons based on auth method
</script>


</body>

</html>
